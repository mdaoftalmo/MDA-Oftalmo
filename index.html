<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Financeiro - Clinica Dr. Leonardo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #f4d03f 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* === ESTILOS DA TELA DE LOGIN === */
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            width: 100%;
            max-width: 900px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 500px;
            margin: 0 auto;
            margin-top: 5vh;
        }

        .login-left {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 60px 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .login-left::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="90" cy="90" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="10" cy="60" r="1" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
            animation: float 20s linear infinite;
        }

        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(-100px) rotate(360deg); }
        }

        .logo {
            font-size: 4em;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
            animation: pulse 2s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        .login-left h1 {
            font-size: 2.2em;
            margin-bottom: 15px;
            font-weight: 300;
            position: relative;
            z-index: 1;
        }

        .login-left p {
            font-size: 1.1em;
            opacity: 0.9;
            line-height: 1.6;
            position: relative;
            z-index: 1;
        }

        .features {
            margin-top: 30px;
            position: relative;
            z-index: 1;
        }

        .feature-item {
            display: flex;
            align-items: center;
            margin: 15px 0;
            font-size: 0.95em;
        }

        .feature-icon {
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 12px;
        }

        .login-right {
            padding: 60px 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .login-form {
            width: 100%;
        }

        .login-form h2 {
            color: #1e3c72;
            font-size: 2em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .login-form .subtitle {
            color: #666;
            margin-bottom: 40px;
            font-size: 1em;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 0.95em;
        }

        .form-group input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2a5298;
            background: white;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }

        .form-group input::placeholder {
            color: #999;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 38px;
            cursor: pointer;
            color: #666;
            font-size: 18px;
            user-select: none;
        }

        .remember-forgot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        .remember-me {
            display: flex;
            align-items: center;
        }

        .remember-me input {
            margin-right: 8px;
            width: auto;
        }

        .forgot-password {
            color: #2a5298;
            text-decoration: none;
            font-weight: 500;
        }

        .forgot-password:hover {
            text-decoration: underline;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(30, 60, 114, 0.3);
        }

        .login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
            border-left: 4px solid #dc3545;
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
            border-left: 4px solid #28a745;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2a5298;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* === ESTILOS DO SISTEMA FINANCEIRO === */
        .sistema-container {
            max-width: 1700px; 
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid white;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 100px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: #f8f9fa;
            font-size: 12px;
            font-weight: 500;
            color: #333;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border-bottom: 3px solid #f4d03f;
        }

        .tab-content {
            display: none;
            padding: 30px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .card h3 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #f4d03f;
            padding-bottom: 5px;
        }

        .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin: 5px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .summary-card h4 {
            margin-bottom: 10px;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .summary-card .value {
            font-size: 1.4em;
            font-weight: bold;
        }

        .transactions-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 5px;
        }

        .transaction-item {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .transaction-item:hover {
            background-color: #f8f9fa;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .transaction-value.receita {
            color: #28a745;
        }

        .transaction-value.despesa {
            color: #dc3545;
        }

        .transaction-date {
            font-size: 0.9em;
            color: #6c757d;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .table th, .table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            font-size: 13px;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .valor-detalhado {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status-pendente {
            background: #ffc107;
            color: #212529;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            border: none;
        }

        .status-pago {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            border: none;
        }

        .status-cancelada {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            border: none;
        }

        /* Estilos específicos para cirurgias */
        .insumo-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }

        .resumo-financeiro {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid #1e3c72;
        }

        .margem-alta {
            color: #28a745 !important;
            font-weight: bold;
        }

        .margem-media {
            color: #ffc107 !important;
            font-weight: bold;
        }

        .margem-baixa {
            color: #dc3545 !important;
            font-weight: bold;
        }

        .detalhes-cirurgia {
            font-size: 0.85em;
            color: #666;
            margin-top: 3px;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .login-container {
                grid-template-columns: 1fr;
                max-width: 400px;
            }

            .login-left {
                padding: 40px 30px;
            }

            .login-right {
                padding: 40px 30px;
            }

            .logo {
                font-size: 3em;
            }

            .features {
                display: none;
            }
        }

        /* Estados de exibição - CORRIGIDO */
        .hidden {
            display: none !important;
        }

        .visible {
            display: block !important;
        }

        /* Animações para notificações */
        @keyframes slideIn {
            0% {
                transform: translateX(100%);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            0% {
                transform: translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Estilos para o status de salvamento */
        .status-salvamento {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .status-salvamento:hover {
            background: rgba(0,0,0,0.9);
        }
    </style>
</head>
<body>
    <div id="telaLogin" class="visible">
        <div class="login-container">
            <div class="login-left">
                <div class="logo">👁️</div>
                <h1>Sistema Financeiro</h1>
                <p>Gestão completa e inteligente para clínicas oftalmológicas</p>
                
                <div class="features">
                    <div class="feature-item">
                        <div class="feature-icon">📊</div>
                        <span>Dashboard em tempo real</span>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">💰</div>
                        <span>Controle de receitas e despesas</span>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">🏥</div>
                        <span>Gestão completa de cirurgias</span>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">📋</div>
                        <span>Relatórios detalhados</span>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">📦</div>
                        <span>Controle de estoque</span>
                    </div>
                </div>
            </div>

            <div class="login-right">
                <form class="login-form" id="loginForm">
                    <h2>Acesso ao Sistema</h2>
                    <p class="subtitle">Entre com suas credenciais para acessar</p>

                    <div class="error-message" id="errorMessage"></div>
                    <div class="success-message" id="successMessage"></div>

                    <div class="form-group">
                        <label for="username">Usuário</label>
                        <input 
                            type="text" 
                            id="username" 
                            name="username" 
                            placeholder="Digite seu usuário"
                            required
                            autocomplete="username"
                        >
                    </div>

                    <div class="form-group">
                        <label for="password">Senha</label>
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            placeholder="Digite sua senha"
                            required
                            autocomplete="current-password"
                        >
                        <span class="password-toggle" onclick="togglePassword()">👁️</span>
                    </div>

                    <div class="remember-forgot">
                        <label class="remember-me">
                            <input type="checkbox" id="rememberMe" name="rememberMe">
                            Lembrar de mim
                        </label>
                        <a href="#" class="forgot-password" onclick="mostrarRecuperacao()">Esqueceu a senha?</a>
                    </div>

                    <button type="submit" class="login-btn" id="loginBtn">
                        Entrar no Sistema
                    </button>

                    <div class="loading" id="loading">
                        <div class="loading-spinner"></div>
                        <span>Verificando credenciais...</span>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="telaSistema" class="hidden">
        <div class="sistema-container">
            <div class="header">
                <button class="logout-btn" onclick="fazerLogout()">🚪 Sair</button>
                <h1>Sistema Financeiro</h1>
                <p>Clinica Oftalmologica Dr. Leonardo</p>
                <div style="margin-top: 15px;">
                    <button onclick="adicionarDadosExemplo()" style="background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 8px 15px; border-radius: 5px; margin: 5px; cursor: pointer;">
                        Adicionar Dados de Exemplo
                    </button>
                    <button onclick="salvarDados()" style="background: rgba(40,167,69,0.8); border: 1px solid white; color: white; padding: 8px 15px; border-radius: 5px; margin: 5px; cursor: pointer;">
                        💾 Salvar Dados
                    </button>
                    <button onclick="exportarBackup()" style="background: rgba(0,123,255,0.8); border: 1px solid white; color: white; padding: 8px 15px; border-radius: 5px; margin: 5px; cursor: pointer;">
                        📥 Baixar Backup
                    </button>
                    <button onclick="document.getElementById('fileInput').click()" style="background: rgba(255,193,7,0.8); border: 1px solid white; color: white; padding: 8px 15px; border-radius: 5px; margin: 5px; cursor: pointer;">
                        📤 Carregar Backup
                    </button>
                    <button onclick="limparTodosDados()" style="background: rgba(220,53,69,0.8); border: 1px solid white; color: white; padding: 8px 15px; border-radius: 5px; margin: 5px; cursor: pointer;">
                        🗑️ Limpar Todos os Dados
                    </button>
                    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="importarBackup(event)">
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="abrirAba('dashboard')">Dashboard</div>
                <div class="tab" onclick="abrirAba('receitas')">Receitas</div>
                <div class="tab" onclick="abrirAba('despesas')">Despesas</div>
                <div class="tab" onclick="abrirAba('cirurgias')">Cirurgias</div>
                <div class="tab" onclick="abrirAba('funcionarios')">Funcionarios</div>
                <div class="tab" onclick="abrirAba('gastosFixos')">Gastos Fixos</div>
                <div class="tab" onclick="abrirAba('parcelas')">Parcelas</div>
                <div class="tab" onclick="abrirAba('insumos')">Insumos</div>
                <div class="tab" onclick="abrirAba('financeiro')">Financeiro</div>
                <div class="tab" onclick="abrirAba('relatorios')">Relatorios</div>
            </div>

            <div id="dashboard" class="tab-content active">
                <div class="summary-cards">
                    <div class="summary-card">
                        <h4>Saldo Atual</h4>
                        <div class="value" id="saldoAtual">R$ 0,00</div>
                    </div>
                    <div class="summary-card">
                        <h4>Receita do Mes</h4>
                        <div class="value" id="totalReceitas">R$ 0,00</div>
                    </div>
                    <div class="summary-card">
                        <h4>Despesas do Mes</h4>
                        <div class="value" id="totalDespesas">R$ 0,00</div>
                    </div>
                    <div class="summary-card">
                        <h4>Gastos Fixos</h4>
                        <div class="value" id="totalGastosFixos">R$ 43.183,01</div>
                    </div>
                    <div class="summary-card">
                        <h4>Resultado do Mes</h4>
                        <div class="value" id="resultado">R$ 0,00</div>
                    </div>
                    <div class="summary-card">
                        <h4>Cirurgias do Mes</h4>
                        <div class="value" id="totalCirurgias">0</div>
                    </div>
                </div>

                <div class="card">
                    <h3>Ultimas Transacoes</h3>
                    <div class="transactions-list" id="ultimasTransacoes">
                        <div class="transaction-item">
                            <div class="transaction-info">
                                <div>Sistema iniciado com sucesso!</div>
                                <div class="transaction-date">Adicione receitas e despesas para comecar</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="receitas" class="tab-content">
                <div class="card">
                    <h3>Registrar Receita</h3>
                    <form id="formReceita">
                        <div class="form-group">
                            <label>Fonte da Receita</label>
                            <select name="fonte" required>
                                <option value="">Selecione...</option>
                                <option value="consultorio-particular">Consultorio Particular</option>
                                <option value="mutiroes">Mutiroes</option>
                                <option value="sus">Servico SUS</option>
                                <option value="cirurgias">Cirurgias</option>
                                <option value="consultas">Consultas</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Descricao</label>
                            <input type="text" name="descricao" placeholder="Ex: Consultas dia 15/05" required>
                        </div>
                        <div class="form-group">
                            <label>Valor (R$)</label>
                            <input type="number" step="0.01" name="valor" placeholder="0,00" required>
                        </div>
                        <div class="form-group">
                            <label>Data</label>
                            <input type="date" name="data" required>
                        </div>
                        <button type="submit" class="btn">Adicionar Receita</button>
                    </form>
                </div>

                <div class="card">
                    <h3>Receitas Registradas</h3>
                    <div class="transactions-list" id="listaReceitas">
                        <div class="transaction-item">
                            <div class="transaction-info">
                                <div>Nenhuma receita registrada ainda</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="despesas" class="tab-content">
                <div class="card">
                    <h3>Registrar Despesa</h3>
                    <form id="formDespesa">
                        <div class="form-group">
                            <label>Categoria</label>
                            <select name="categoria" required>
                                <option value="">Selecione...</option>
                                <option value="insumos">Insumos Médicos</option>
                                <option value="gasolina">Gasolina</option>
                                <option value="alimentacao">Alimentação</option>
                                <option value="manutencao">Manutenção</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Descrição</label>
                            <input type="text" name="descricao" placeholder="Ex: Combustível para viagem" required>
                        </div>
                        <div class="form-group">
                            <label>Valor (R$)</label>
                            <input type="number" step="0.01" name="valor" placeholder="0,00" required>
                        </div>
                        <div class="form-group">
                            <label>Data</label>
                            <input type="date" name="data" required>
                        </div>
                        <button type="submit" class="btn">Adicionar Despesa</button>
                    </form>
                </div>

                <div class="card">
                    <h3>Despesas Registradas</h3>
                    <div class="transactions-list" id="listaDespesas">
                        <div class="transaction-item">
                            <div class="transaction-info">
                                <div>Nenhuma despesa registrada ainda</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="financeiro" class="tab-content">
                <div class="card">
                    <h3>Controle de Saldo</h3>
                    <div class="form-group">
                        <label>Saldo Atual da Conta (R$) - Calculado Automaticamente</label>
                        <input type="number" step="0.01" id="inputSaldo" placeholder="0,00">
                    </div>
                    <button type="button" class="btn" onclick="atualizarSaldo()">Atualizar Saldo</button>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                        <h4>Situacao Financeira:</h4>
                        <div class="valor-detalhado">
                            <span>Saldo Atual:</span>
                            <span id="displaySaldo">R$ 0,00</span>
                        </div>
                        <div class="valor-detalhado">
                            <span>Gastos Fixos Mensais:</span>
                            <span>R$ 43.183,01</span>
                        </div>
                        <hr>
                        <div class="valor-detalhado">
                            <span><strong>Saldo Projetado:</strong></span>
                            <span id="saldoProjetado"><strong>R$ -43.183,01</strong></span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="cirurgias" class="tab-content">
                <div class="grid">
                    <div class="card">
                        <h3>Registrar Cirurgia</h3>
                        <form id="formCirurgia">
                            <div class="form-group">
                                <label>Tipo de Cirurgia</label>
                                <select name="tipo" required>
                                    <option value="">Selecione...</option>
                                    <option value="catarata">Catarata</option>
                                    <option value="retina">Retina</option>
                                    <option value="glaucoma">Glaucoma</option>
                                    <option value="refrativa">Refrativa</option>
                                    <option value="pterígio">Pterígio</option>
                                    <option value="outras">Outras</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Paciente</label>
                                <input type="text" name="paciente" placeholder="Nome do paciente" required>
                            </div>
                            <div class="form-group">
                                <label>Valor Bruto (R$)</label>
                                <input type="number" step="0.01" name="valorBruto" placeholder="0,00" required id="valorBrutoCirurgia">
                            </div>
                            <div class="form-group">
                                <label>Forma de Pagamento</label>
                                <select name="formaPagamento" required id="formaPagamentoCirurgia">
                                    <option value="">Selecione...</option>
                                    <option value="dinheiro">Dinheiro/PIX</option>
                                    <option value="cartao-debito">Cartão Débito</option>
                                    <option value="cartao-credito-vista">Cartão Crédito à Vista</option>
                                    <option value="cartao-credito-parcelado">Cartão Crédito Parcelado</option>
                                </select>
                            </div>
                            <div class="form-group" id="taxaCartaoGroup" style="display: none;">
                                <label>Taxa da Máquina (%)</label>
                                <input type="number" step="0.01" name="taxaCartao" placeholder="Ex: 3.5" id="taxaCartaoCirurgia">
                            </div>
                            <div class="form-group">
                                <label>Data da Cirurgia</label>
                                <input type="date" name="data" required>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select name="status" required>
                                    <option value="agendada">Agendada</option>
                                    <option value="realizada">Realizada</option>
                                    <option value="cancelada">Cancelada</option>
                                </select>
                            </div>

                            <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; margin: 15px 0;">
                                <h4>Custos Operacionais</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label>Comissão Orientadora (%)</label>
                                        <input type="number" step="0.01" name="comissaoOrientadora" placeholder="3.0" value="3.0" id="comissaoOrientadora">
                                    </div>
                                    <div class="form-group">
                                        <label>Instrumentadora (R$)</label>
                                        <input type="number" step="0.01" name="valorInstrumentadora" placeholder="200.00" value="200.00" id="valorInstrumentadora">
                                    </div>
                                    <div class="form-group">
                                        <label>Outros Custos (R$)</label>
                                        <input type="number" step="0.01" name="outrosCustos" placeholder="0.00" id="outrosCustos">
                                    </div>
                                </div>
                                
                                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                    <div class="valor-detalhado">
                                        <span>Comissão Orientadora:</span>
                                        <span id="valorComissaoOrientadora"><strong>R$ 0,00</strong></span>
                                    </div>
                                    <div class="valor-detalhado">
                                        <span>Funcionários por Dia:</span>
                                        <span id="custoFuncionariosDia"><strong>R$ 0,00</strong></span>
                                    </div>
                                    <div class="valor-detalhado">
                                        <span>Total Custos Operacionais:</span>
                                        <span id="totalCustosOperacionais"><strong>R$ 0,00</strong></span>
                                    </div>
                                </div>
                            </div>

                            <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; margin: 15px 0;">
                                <h4>Insumos Utilizados</h4>
                                <div id="insumosUtilizados">
                                    <div class="insumo-item" style="display: flex; gap: 10px; margin: 10px 0; align-items: center;">
    <input type="text" class="codigo-barras-insumo" placeholder="Escaneie o código" style="flex: 2;">
    <select class="insumo-select" style="flex: 2;">
        <option value="">Selecione um insumo...</option>
    </select>
    <input type="number" class="quantidade-insumo" placeholder="Qtd" style="width: 80px;" min="1">
    <span class="preco-insumo" style="width: 100px; font-weight: bold;"></span>
    <button type="button" class="btn-remover-insumo" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; flex-shrink: 0; margin-left: 5px;">Remover</button>
</div>
                                </div>
                                <button type="button" id="adicionarInsumo" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-top: 10px;">+ Adicionar Insumo</button>
                                
                                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                    <div class="valor-detalhado">
                                        <span>Total Insumos:</span>
                                        <span id="totalInsumos"><strong>R$ 0,00</strong></span>
                                    </div>
                                </div>
                            </div>

                            <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; margin: 15px 0; background: #f8f9fa;">
                                <h4>Resumo Financeiro Completo</h4>
                                <div class="valor-detalhado">
                                    <span>Valor Bruto:</span>
                                    <span id="resumoValorBruto">R$ 0,00</span>
                                </div>
                                <div class="valor-detalhado">
                                    <span>(-) Taxa Cartão:</span>
                                    <span id="resumoTaxaCartao">R$ 0,00</span>
                                </div>
                                <div class="valor-detalhado">
                                    <span>(-) Impostos (18%):</span>
                                    <span id="resumoImpostos">R$ 0,00</span>
                                </div>
                                <div class="valor-detalhado">
                                    <span>(-) Comissão Orientadora:</span>
                                    <span id="resumoComissaoOrientadora">R$ 0,00</span>
                                </div>
                                <div class="valor-detalhado">
                                    <span>(-) Instrumentadora:</span>
                                    <span id="resumoInstrumentadora">R$ 0,00</span>
                                </div>
                                <div class="valor-detalhado">
                                    <span>(-) Funcionários/Dia:</span>
                                    <span id="resumoFuncionarios">R$ 0,00</span>
                                </div>
                                <div class="valor-detalhado">
                                    <span>(-) Custo Insumos:</span>
                                    <span id="resumoCustoInsumos">R$ 0,00</span>
                                </div>
                                <div class="valor-detalhado">
                                    <span>(-) Outros Custos:</span>
                                    <span id="resumoOutrosCustos">R$ 0,00</span>
                                </div>
                                <hr>
                                <div class="valor-detalhado">
                                    <span><strong>Valor Líquido Final:</strong></span>
                                    <span id="resumoValorLiquido" style="color: #28a745;"><strong>R$ 0,00</strong></span>
                                </div>
                                <div class="valor-detalhado">
                                    <span><strong>Margem (%):</strong></span>
                                    <span id="resumoMargem" style="color: #28a745;"><strong>0%</strong></span>
                                </div>
                                <div class="valor-detalhado">
                                    <span><strong>Total de Custos:</strong></span>
                                    <span id="resumoTotalCustos" style="color: #dc3545;"><strong>R$ 0,00</strong></span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Observações</label>
                                <textarea name="observacoes" placeholder="Observações adicionais" rows="3"></textarea>
                            </div>
                            <button type="submit" class="btn">Registrar Cirurgia</button>
                        </form>
                    </div>

                    <div class="card">
                        <h3>Resumo de Cirurgias</h3>
                        <div class="summary-cards">
                            <div class="summary-card">
                                <h4>Total Realizadas</h4>
                                <div class="value" id="cirurgiasRealizadas">0</div>
                            </div>
                            <div class="summary-card">
                                <h4>Agendadas</h4>
                                <div class="value" id="cirurgiasAgendadas">0</div>
                            </div>
                            <div class="summary-card">
                                <h4>Faturamento Bruto</h4>
                                <div class="value" id="faturamentoBruto">R$ 0,00</div>
                            </div>
                            <div class="summary-card">
                                <h4>Faturamento Líquido</h4>
                                <div class="value" id="faturamentoLiquido">R$ 0,00</div>
                            </div>
                            <div class="summary-card">
                                <h4>Margem Média</h4>
                                <div class="value" id="margemMedia">0%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Lista de Cirurgias</h3>
                    <div class="transactions-list" id="listaCirurgias">
                        <div class="transaction-item">
                            <div class="transaction-info">
                                <div>Nenhuma cirurgia registrada ainda</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="funcionarios" class="tab-content">
                <div class="grid">
                    <div class="card">
                        <h3>Registrar Funcionário</h3>
                        <form id="formFuncionario">
                            <div class="form-group">
                                <label>Nome</label>
                                <input type="text" name="nome" placeholder="Nome completo" required>
                            </div>
                            <div class="form-group">
                                <label>Cargo</label>
                                <select name="cargo" required>
                                    <option value="">Selecione...</option>
                                    <option value="enfermeiro">Enfermeiro(a)</option>
                                    <option value="tecnico">Técnico(a)</option>
                                    <option value="recepcionista">Recepcionista</option>
                                    <option value="auxiliar">Auxiliar</option>
                                    <option value="limpeza">Limpeza</option>
                                    <option value="outros">Outros</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tipo de Pagamento</label>
                                <select name="tipoPagamento" required id="tipoPagamentoFuncionario">
                                    <option value="">Selecione...</option>
                                    <option value="mensal">Salário Mensal</option>
                                    <option value="diario">Por Dia de Cirurgia</option>
                                    <option value="por-dia">Por Dia</option>
                                </select>
                            </div>
                            <div class="form-group" id="salarioMensalGroup">
                                <label>Salário Mensal (R$)</label>
                                <input type="number" step="0.01" name="salario" placeholder="0,00" id="salarioMensal">
                            </div>
                            <div class="form-group" id="valorDiarioGroup" style="display: none;">
                                <label>Valor por Dia de Cirurgia (R$)</label>
                                <input type="number" step="0.01" name="valorDiario" placeholder="0,00" id="valorDiario">
                            </div>
                            <div class="form-group">
                                <label>Data de Admissão</label>
                                <input type="date" name="dataAdmissao" required>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select name="status" required>
                                    <option value="ativo">Ativo</option>
                                    <option value="inativo">Inativo</option>
                                    <option value="ferias">Férias</option>
                                </select>
                            </div>
                            <button type="submit" class="btn">Registrar Funcionário</button>
                        </form>
                    </div>

                    <div class="card">
                        <h3>Resumo da Folha</h3>
                        <div class="summary-cards">
                            <div class="summary-card">
                                <h4>Funcionários Ativos</h4>
                                <div class="value" id="funcionariosAtivos">0</div>
                            </div>
                            <div class="summary-card">
                                <h4>Folha Mensal</h4>
                                <div class="value" id="totalFolha">R$ 0,00</div>
                            </div>
                            <div class="summary-card">
                                <h4>Custo por Cirurgia</h4>
                                <div class="value" id="custoPorCirurgia">R$ 0,00</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Lista de Funcionários</h3>
                    <div class="transactions-list" id="listaFuncionarios">
                        <div class="transaction-item">
                            <div class="transaction-info">
                                <div>Nenhum funcionário registrado ainda</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="gastosFixos" class="tab-content">
                <div class="grid">
                    <div class="card">
                        <h3>Registrar Gasto Fixo</h3>
                        <form id="formGastoFixo">
                            <div class="form-group">
                                <label>Descrição</label>
                                <input type="text" name="descricao" placeholder="Ex: Aluguel consultório" required>
                            </div>
                            <div class="form-group">
                                <label>Categoria</label>
                                <select name="categoria" required>
                                    <option value="">Selecione...</option>
                                    <option value="aluguel">Aluguel</option>
                                    <option value="salarios">Salários</option>
                                    <option value="encargos">Encargos</option>
                                    <option value="energia">Energia Elétrica</option>
                                    <option value="agua">Água</option>
                                    <option value="telefone">Telefone/Internet</option>
                                    <option value="seguros">Seguros</option>
                                    <option value="outros">Outros</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Valor Mensal (R$)</label>
                                <input type="number" step="0.01" name="valor" placeholder="0,00" required>
                            </div>
                            <div class="form-group">
                                <label>Dia do Vencimento</label>
                                <input type="number" min="1" max="31" name="diaVencimento" placeholder="Ex: 5" required>
                            </div>
                            <button type="submit" class="btn">Adicionar Gasto Fixo</button>
                        </form>
                    </div>

                    <div class="card">
                        <h3>Resumo dos Gastos</h3>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 5px;">
                            <div class="valor-detalhado">
                                <span><strong>Total de Gastos Fixos:</strong></span>
                                <span id="totalGastosFixosDetalhado"><strong>R$ 0,00</strong></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Lista de Gastos Fixos</h3>
                    <div class="transactions-list" id="listaGastosFixos">
                        <div class="transaction-item">
                            <div class="transaction-info">
                                <div>Nenhum gasto fixo registrado ainda</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="parcelas" class="tab-content">
                <div class="grid">
                    <div class="card">
                        <h3>Registrar Parcela</h3>
                        <form id="formParcela">
                            <div class="form-group">
                                <label>Tipo</label>
                                <select name="tipo" required>
                                    <option value="">Selecione...</option>
                                    <option value="pagar">A Pagar</option>
                                    <option value="receber">A Receber</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Descrição</label>
                                <input type="text" name="descricao" placeholder="Ex: Financiamento equipamento" required>
                            </div>
                            <div class="form-group">
                                <label>Valor da Parcela (R$)</label>
                                <input type="number" step="0.01" name="valor" placeholder="0,00" required>
                            </div>
                            <div class="form-group">
                                <label>Número de Parcelas</label>
                                <input type="number" name="numeroParcelas" placeholder="Ex: 12" min="1" required>
                            </div>
                            <div class="form-group">
                                <label>Data de Vencimento</label>
                                <input type="date" name="dataVencimento" required>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select name="status" required>
                                    <option value="pendente">Pendente</option>
                                    <option value="pago">Pago</option>
                                    <option value="vencido">Vencido</option>
                                </select>
                            </div>
                            <button type="submit" class="btn">Registrar Parcela</button>
                        </form>
                    </div>

                    <div class="card">
                        <h3>Resumo de Parcelas</h3>
                        <div class="summary-cards">
                            <div class="summary-card">
                                <h4>A Pagar</h4>
                                <div class="value" id="totalAPagar">R$ 0,00</div>
                            </div>
                            <div class="summary-card">
                                <h4>A Receber</h4>
                                <div class="value" id="totalAReceber">R$ 0,00</div>
                            </div>
                            <div class="summary-card">
                                <h4>Total de Parcelas</h4>
                                <div class="value" id="totalParcelasRegistradas">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Lista de Parcelas</h3>
                    <div class="transactions-list" id="listaParcelas">
                        <div class="transaction-item">
                            <div class="transaction-info">
                                <div>Nenhuma parcela registrada ainda</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="insumos" class="tab-content">
                <div class="grid">
                    <div class="card">
                        <h3>Registrar Insumo</h3>
                        <form id="formInsumo">
                            <div class="form-group">
                                <label>Nome do Insumo</label>
                                <input type="text" name="nome" placeholder="Ex: Seringa 5ml" required>
                            </div>
                            <div class="form-group">
                                <label>Categoria</label>
                                <select name="categoria" required>
                                    <option value="">Selecione...</option>
                                    <option value="descartaveis">Descartáveis</option>
                                    <option value="medicamentos">Medicamentos</option>
                                    <option value="equipamentos">Equipamentos</option>
                                    <option value="limpeza">Limpeza</option>
                                    <option value="outros">Outros</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Quantidade</label>
                                <input type="number" name="quantidade" placeholder="Ex: 100" required>
                            </div>
                            <div class="form-group">
                                <label>Unidade</label>
                                <select name="unidade" required>
                                    <option value="unidade">Unidade</option>
                                    <option value="caixa">Caixa</option>
                                    <option value="frasco">Frasco</option>
                                    <option value="pacote">Pacote</option>
                                    <option value="litro">Litro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Preço Unitário (R$)</label>
                                <input type="number" step="0.01" name="preco" placeholder="0,00" required>
                            </div>
                            <div class="form-group">
                                <label>Estoque Mínimo</label>
                                <input type="number" name="estoqueMinimo" placeholder="Ex: 10" required>
                            </div>
                            <div class="form-group">
                                <label>Código de Barras</label>
                                <input type="text" name="codigoBarras" placeholder="Escaneie o código" required>
                            </div>
                            </div>
                            <button type="submit" class="btn">Adicionar Insumo</button>
                        </form>
                    </div>

                    <div class="card">
                        <h3>Resumo do Estoque</h3>
                        <div class="summary-cards">
                            <div class="summary-card">
                                <h4>Itens Cadastrados</h4>
                                <div class="value" id="totalItens">0</div>
                            </div>
                            <div class="summary-card">
                                <h4>Itens em Falta</h4>
                                <div class="value" id="itensEmFalta">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Buscar Produto por Código de Barras</h3>
                    <div class="form-group">
                        <input type="text" id="buscarCodigoBarras" placeholder="Escaneie ou digite o código">
                    </div>
                    <div id="resultadoBusca"></div>
                </div>

                <div class="card">
                    <h3>Lista de Insumos</h3>
                    <div class="transactions-list" id="listaInsumos">
                        <div class="transaction-item">
                            <div class="transaction-info">
                                <div>Nenhum insumo registrado ainda</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="relatorios" class="tab-content">
                <div class="grid">
                    <div class="card">
                        <h3>Filtros de Relatório</h3>
                        <div class="form-group">
                            <label>Período</label>
                            <select id="periodoRelatorio">
                                <option value="mes-atual">Mês Atual</option>
                                <option value="mes-anterior">Mês Anterior</option>
                                <option value="trimestre">Últimos 3 Meses</option>
                                <option value="semestre">Últimos 6 Meses</option>
                                <option value="ano">Último Ano</option>
                                <option value="personalizado">Período Personalizado</option>
                            </select>
                        </div>
                        <div class="form-group" id="periodoPersonalizado" style="display: none;">
                            <label>Data Inicial</label>
                            <input type="date" id="dataInicial">
                            <label>Data Final</label>
                            <input type="date" id="dataFinal">
                        </div>
                        <button type="button" class="btn" onclick="gerarRelatorio()">Gerar Relatório</button>
                    </div>

                    <div class="card">
                        <h3>Ações Rápidas</h3>
                        <button type="button" class="btn" onclick="exportarDados('receitas')">Exportar Receitas</button>
                        <button type="button" class="btn" onclick="exportarDados('despesas')">Exportar Despesas</button>
                        <button type="button" class="btn" onclick="exportarDados('cirurgias')">Exportar Cirurgias</button>
                        <button type="button" class="btn" onclick="exportarDados('completo')">Relatório Completo</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Relatório Financeiro</h3>
                    <div id="relatorioConteudo">
                        <p>Selecione um período e clique em "Gerar Relatório" para visualizar os dados.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === CONFIGURAÇÕES DE LOGIN ===
        const USUARIO_VALIDO = 'leosht';
        const SENHA_VALIDA = 'mda12345';

        // === DADOS DO SISTEMA ===
        let dados = {
            receitas: [],
            despesas: [],
            cirurgias: [],
            parcelas: [],
            insumos: [],
            saldoAtual: 0 // Este valor não é mais a fonte da verdade, mas é mantido por compatibilidade.
        };

        let usuarioLogado = false;

        // === FUNÇÕES DE SALVAMENTO ===
        function salvarDados() {
            try {
                const dadosParaSalvar = {
                    ...dados,
                    dataUltimaSalvamento: new Date().toISOString(),
                    versaoSistema: '1.0'
                };
                
                localStorage.setItem('sistemaFinanceiro_dados', JSON.stringify(dadosParaSalvar));
                localStorage.setItem('sistemaFinanceiro_ultimoSalvamento', new Date().toLocaleString('pt-BR'));
                
                mostrarNotificacao('💾 Dados salvos com sucesso!', 'success');
                atualizarStatusSalvamento();
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
                mostrarNotificacao('❌ Erro ao salvar dados!', 'error');
            }
        }

        function carregarDados() {
            try {
                const dadosSalvos = localStorage.getItem('sistemaFinanceiro_dados');
                if (dadosSalvos) {
                    const dadosCarregados = JSON.parse(dadosSalvos);
                    
                    // Manter compatibilidade com versões antigas
                    dados = {
                        receitas: dadosCarregados.receitas || [],
                        despesas: dadosCarregados.despesas || [],
                        cirurgias: dadosCarregados.cirurgias || [],
                        parcelas: dadosCarregados.parcelas || [],
                        insumos: dadosCarregados.insumos || [],
                        saldoAtual: dadosCarregados.saldoAtual || 0 // Carrega o saldo antigo, mas será recalculado
                    };
                    
                    mostrarNotificacao('📂 Dados carregados com sucesso!', 'success');
                    atualizarStatusSalvamento();
                    return true;
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                mostrarNotificacao('❌ Erro ao carregar dados salvos!', 'error');
            }
            return false;
        }

        function salvarAutomatico() {
            if (usuarioLogado) {
                salvarDados();
            }
        }

        function exportarBackup() {
            try {
                const backup = {
                    ...dados,
                    metadados: {
                        dataExportacao: new Date().toISOString(),
                        dataUltimaSalvamento: localStorage.getItem('sistemaFinanceiro_ultimoSalvamento'),
                        versaoSistema: '1.0',
                        nomeClinica: 'Clínica Oftalmológica Dr. Leonardo'
                    }
                };
                
                const dataStr = JSON.stringify(backup, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `backup_clinica_${new Date().toISOString().slice(0, 10)}.json`;
                link.click();
                
                mostrarNotificacao('📥 Backup baixado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao exportar backup:', error);
                mostrarNotificacao('❌ Erro ao gerar backup!', 'error');
            }
        }

        function importarBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                mostrarNotificacao('❌ Arquivo deve ser .json!', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    // Validar estrutura do backup
                    if (!backup.receitas && !backup.despesas && !backup.metadados) {
                        throw new Error('Arquivo de backup inválido');
                    }
                    
                    // Confirmar importação
                    if (confirm('⚠️ Importar backup substituirá todos os dados atuais. Deseja continuar?')) {
                        dados = {
                            receitas: backup.receitas || [],
                            despesas: backup.despesas || [],
                            cirurgias: backup.cirurgias || [],
                            parcelas: backup.parcelas || [],
                            insumos: backup.insumos || [],
                            saldoAtual: backup.saldoAtual || 0
                        };
                        
                        salvarDados();
                        atualizarTodasAsVisualizacoes();
                        mostrarNotificacao('📤 Backup importado com sucesso!', 'success');
                    }
                } catch (error) {
                    console.error('Erro ao importar backup:', error);
                    mostrarNotificacao('❌ Erro ao importar backup! Arquivo pode estar corrompido.', 'error');
                }
                
                // Limpar input
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function mostrarNotificacao(mensagem, tipo = 'info') {
            // Remover notificação anterior se existir
            const notificacaoExistente = document.querySelector('.notificacao-sistema');
            if (notificacaoExistente) {
                notificacaoExistente.remove();
            }
            
            const notificacao = document.createElement('div');
            notificacao.className = 'notificacao-sistema';
            notificacao.textContent = mensagem;
            
            // Estilos baseados no tipo
            const cores = {
                success: '#28a745',
                error: '#dc3545',
                info: '#17a2b8',
                warning: '#ffc107'
            };
            
            notificacao.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${cores[tipo] || cores.info};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: 500;
                max-width: 300px;
                animation: slideIn 0.3s ease-out;
            `;
            
            document.body.appendChild(notificacao);
            
            // Remover após 4 segundos
            setTimeout(() => {
                if (notificacao.parentNode) {
                    notificacao.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => notificacao.remove(), 300);
                }
            }, 4000);
        }

        function atualizarStatusSalvamento() {
            const ultimoSalvamento = localStorage.getItem('sistemaFinanceiro_ultimoSalvamento');
            let statusElement = document.getElementById('statusSalvamento');
            
            if (!statusElement) {
                statusElement = document.createElement('div');
                statusElement.id = 'statusSalvamento';
                statusElement.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: rgba(0,0,0,0.7);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 5px;
                    font-size: 12px;
                    z-index: 1000;
                `;
                document.body.appendChild(statusElement);
            }
            
            if (ultimoSalvamento) {
                statusElement.textContent = `💾 Último salvamento: ${ultimoSalvamento}`;
                statusElement.style.display = 'block';
            } else {
                statusElement.style.display = 'none';
            }
        }

        function atualizarTodasAsVisualizacoes() {
            if (!usuarioLogado) return;
            
            atualizarDashboard();
            atualizarListaReceitas();
            atualizarListaDespesas();
            atualizarListaCirurgias();
            atualizarResumoCirurgias();
            atualizarListaParcelas();
            atualizarResumoParcelas();
            atualizarListaInsumos();
            atualizarResumoInsumos();
            atualizarFinanceiro();
        }

        // === FUNÇÕES DE LOGIN ===
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const passwordToggle = document.querySelector('.password-toggle');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                passwordToggle.textContent = '🙈';
            } else {
                passwordInput.type = 'password';
                passwordToggle.textContent = '👁️';
            }
        }

        function mostrarRecuperacao() {
            alert('Para recuperar sua senha, entre em contato com o Dr. Leonardo.\n\nTelefone: (42) 99999-9999\nEmail: contato@drleonardo.com.br');
        }

        function realizarLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!username || !password) {
                mostrarErro('Por favor, preencha todos os campos!');
                return;
            }

            mostrarLoading(true);

            setTimeout(() => {
                if (username === USUARIO_VALIDO && password === SENHA_VALIDA) {
                    mostrarSucesso('Login realizado com sucesso! Carregando sistema...');
                    
                    if (document.getElementById('rememberMe').checked) {
                        // Removido localStorage para funcionar nos artifacts
                    }

                    usuarioLogado = true;
                    
                    setTimeout(() => {
                        mostrarSistema();
                    }, 1500);

                } else {
                    mostrarErro('Usuário ou senha incorretos! Verifique suas credenciais.');
                    mostrarLoading(false);
                    document.getElementById('password').value = '';
                }
            }, 1000);
        }

        function fazerLogout() {
            if (confirm('Tem certeza que deseja sair do sistema?')) {
                usuarioLogado = false;
                mostrarLogin();
            }
        }

        function mostrarLogin() {
            // CORRIGIDO: Usar classes em vez de style.display
            document.getElementById('telaLogin').className = 'visible';
            document.getElementById('telaSistema').className = 'hidden';
            document.getElementById('loginForm').reset();
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        function mostrarSistema() {
            // CORRIGIDO: Usar classes em vez de style.display
            document.getElementById('telaLogin').className = 'hidden';
            document.getElementById('telaSistema').className = 'visible';
            
            // Carregar dados salvos
            carregarDados();
            
            atualizarTodasAsVisualizacoes();
            atualizarStatusSalvamento();
        }

        function mostrarErro(mensagem) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = mensagem;
            errorMessage.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
            
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        function mostrarSucesso(mensagem) {
            const successMessage = document.getElementById('successMessage');
            successMessage.textContent = mensagem;
            successMessage.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function mostrarLoading(mostrar) {
            const loading = document.getElementById('loading');
            const loginBtn = document.getElementById('loginBtn');
            
            if (mostrar) {
                loading.style.display = 'block';
                loginBtn.disabled = true;
                loginBtn.textContent = 'Verificando...';
            } else {
                loading.style.display = 'none';
                loginBtn.disabled = false;
                loginBtn.textContent = 'Entrar no Sistema';
            }
        }

        // === FUNÇÕES DO SISTEMA FINANCEIRO ===
        function abrirAba(nomeAba) {
            if (!usuarioLogado) return;
            
            // Esconder todas as abas
            var todasAbas = document.querySelectorAll('.tab-content');
            for (var i = 0; i < todasAbas.length; i++) {
                todasAbas[i].classList.remove('active');
            }
            
            // Remover active de todos os botoes
            var todosBotoes = document.querySelectorAll('.tab');
            for (var i = 0; i < todosBotoes.length; i++) {
                todosBotoes[i].classList.remove('active');
            }
            
            // Mostrar a aba selecionada
            document.getElementById(nomeAba).classList.add('active');
            
            // Ativar o botao clicado
            event.target.classList.add('active');
            
            // Carregar conteudo da aba
            setTimeout(function() {
                if (nomeAba === 'dashboard') {
                    atualizarDashboard();
                } else if (nomeAba === 'receitas') {
                    atualizarListaReceitas();
                } else if (nomeAba === 'despesas') {
                    atualizarListaDespesas();
                } else if (nomeAba === 'cirurgias') {
                    atualizarListaCirurgias();
                    atualizarResumoCirurgias();
                    carregarInsumosNoSelect();
                } else if (nomeAba === 'parcelas') {
                    atualizarListaParcelas();
                    atualizarResumoParcelas();
                } else if (nomeAba === 'insumos') {
                    atualizarListaInsumos();
                    atualizarResumoInsumos();
                } else if (nomeAba === 'financeiro') {
                    atualizarFinanceiro();
                }
            }, 100);
        }

        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        function formatarData(data) {
            return new Date(data + 'T00:00:00').toLocaleDateString('pt-BR');
        }

        function atualizarDashboard() {
            if (!usuarioLogado) return;
            
            var mesAtual = new Date().toISOString().slice(0, 7);
            
            var totalReceitas = 0;
            var totalDespesas = 0;
            var totalCirurgias = 0;
            
            dados.receitas.forEach(function(receita) {
                if (receita.data.startsWith(mesAtual)) {
                    totalReceitas += parseFloat(receita.valor);
                }
            });
            
            dados.despesas.forEach(function(despesa) {
                if (despesa.data.startsWith(mesAtual)) {
                    totalDespesas += parseFloat(despesa.valor);
                }
            });
            
            dados.cirurgias.forEach(function(cirurgia) {
                if (cirurgia.data.startsWith(mesAtual)) {
                    totalCirurgias++;
                }
            });
            
            var resultado = totalReceitas - totalDespesas;
            
            document.getElementById('saldoAtual').textContent = formatarMoeda(calcularSaldoAtualGlobal());
            document.getElementById('totalReceitas').textContent = formatarMoeda(totalReceitas);
            document.getElementById('totalDespesas').textContent = formatarMoeda(totalDespesas);
            document.getElementById('resultado').textContent = formatarMoeda(resultado);
            document.getElementById('totalCirurgias').textContent = totalCirurgias;
            
            atualizarUltimasTransacoes();
        }

        function atualizarUltimasTransacoes() {
            var container = document.getElementById('ultimasTransacoes');
            if (dados.receitas.length === 0 && dados.despesas.length === 0) {
                container.innerHTML = '<div class="transaction-item"><div class="transaction-info"><div>Nenhuma transacao registrada ainda</div><div class="transaction-date">Adicione receitas e despesas para comecar</div></div></div>';
            } else {
                var html = '';
                var todasTransacoes = [];
                
                // Combinar receitas e despesas
                dados.receitas.forEach(function(receita) {
                    todasTransacoes.push({
                        tipo: 'receita',
                        descricao: receita.descricao,
                        valor: receita.valor,
                        data: receita.data
                    });
                });
                
                dados.despesas.forEach(function(despesa) {
                    todasTransacoes.push({
                        tipo: 'despesa',
                        descricao: despesa.descricao,
                        valor: despesa.valor,
                        data: despesa.data
                    });
                });
                
                // Ordenar por data (mais recentes primeiro)
                todasTransacoes.sort(function(a, b) {
                    return new Date(b.data) - new Date(a.data);
                });
                
                // Mostrar apenas as 5 mais recentes
                todasTransacoes.slice(0, 5).forEach(function(transacao) {
                    html += '<div class="transaction-item">';
                    html += '<div class="transaction-info">';
                    html += '<div>' + transacao.descricao + '</div>';
                    html += '<div class="transaction-date">' + formatarData(transacao.data) + '</div>';
                    html += '</div>';
                    html += '<div class="transaction-value ' + transacao.tipo + '">';
                    html += (transacao.tipo === 'receita' ? '+' : '-') + formatarMoeda(transacao.valor);
                    html += '</div>';
                    html += '</div>';
                });
                
                container.innerHTML = html;
            }
        }

        function atualizarListaReceitas() {
            var container = document.getElementById('listaReceitas');
            if (dados.receitas.length === 0) {
                container.innerHTML = '<div class="transaction-item"><div class="transaction-info"><div>Nenhuma receita registrada ainda</div></div></div>';
            } else {
                var html = '';
                dados.receitas.forEach(function(receita) {
                    html += '<div class="transaction-item">';
                    html += '<div class="transaction-info">';
                    html += '<div><strong>' + receita.descricao + '</strong></div>';
                    html += '<div class="transaction-date">' + formatarData(receita.data) + ' | ' + receita.fonte + '</div>';
                    html += '</div>';
                    html += '<div class="transaction-value receita">' + formatarMoeda(receita.valor) + '</div>';
                    html += '<button class="delete-btn" onclick="excluirReceita(' + receita.id + ')">Excluir</button>';
                    html += '</div>';
                });
                container.innerHTML = html;
            }
        }

        function atualizarListaDespesas() {
            var container = document.getElementById('listaDespesas');
            if (dados.despesas.length === 0) {
                container.innerHTML = '<div class="transaction-item"><div class="transaction-info"><div>Nenhuma despesa registrada ainda</div></div></div>';
            } else {
                var html = '';
                dados.despesas.forEach(function(despesa) {
                    html += '<div class="transaction-item">';
                    html += '<div class="transaction-info">';
                    html += '<div><strong>' + despesa.descricao + '</strong></div>';
                    html += '<div class="transaction-date">' + formatarData(despesa.data) + ' | ' + despesa.categoria + '</div>';
                    html += '</div>';
                    html += '<div class="transaction-value despesa">' + formatarMoeda(despesa.valor) + '</div>';
                    html += '<button class="delete-btn" onclick="excluirDespesa(' + despesa.id + ')">Excluir</button>';
                    html += '</div>';
                });
                container.innerHTML = html;
            }
        }
        
        // NOVA FUNÇÃO: Calcula o saldo total com base em TODAS as receitas e despesas
        function calcularSaldoAtualGlobal() {
            const totalReceitas = dados.receitas.reduce((acc, receita) => acc + parseFloat(receita.valor), 0);
            const totalDespesas = dados.despesas.reduce((acc, despesa) => acc + parseFloat(despesa.valor), 0);
            return totalReceitas - totalDespesas;
        }

        function atualizarFinanceiro() {
            if (!usuarioLogado) return;
            
            // Calcula o saldo atual dinamicamente
            const saldoCalculado = calcularSaldoAtualGlobal();
            
            // Atualiza a interface da aba "Financeiro"
            document.getElementById('inputSaldo').value = saldoCalculado.toFixed(2);
            document.getElementById('displaySaldo').textContent = formatarMoeda(saldoCalculado);
            
            // O campo de input agora é apenas para visualização
            document.getElementById('inputSaldo').readOnly = true; 
            document.getElementById('inputSaldo').style.background = '#e9ecef';

            // A projeção continua funcionando
            const totalGastosFixos = dados.gastosFixos.reduce((total, g) => total + parseFloat(g.valor), 0);
            var saldoProjetado = saldoCalculado - totalGastosFixos;
            document.getElementById('saldoProjetado').innerHTML = '<strong>' + formatarMoeda(saldoProjetado) + '</strong>';

            // Desabilita o botão que não é mais necessário
            const btnAtualizar = document.querySelector('#financeiro .btn');
            if(btnAtualizar) {
                btnAtualizar.textContent = 'Saldo Automático';
                btnAtualizar.disabled = true;
            }
        }

        function atualizarSaldo() {
            // Esta função agora está obsoleta, mas é mantida para não quebrar o botão onclick.
            // A lógica real está em `atualizarFinanceiro`.
            mostrarNotificacao('ℹ️ O saldo é atualizado automaticamente.', 'info');
        }

        function adicionarDadosExemplo() {
            if (!usuarioLogado) return;
            
            if (confirm('Deseja adicionar alguns dados de exemplo para testar o sistema?')) {
                // Receitas
                dados.receitas.push({
                    id: 1001,
                    fonte: 'cirurgias',
                    descricao: 'Cirurgia de Retina - Joao Silva',
                    valor: 8500,
                    data: '2024-06-15'
                });
                
                dados.receitas.push({
                    id: 1002,
                    fonte: 'consultas',
                    descricao: 'Consultas da semana',
                    valor: 2400,
                    data: '2024-06-20'
                });
                
                // Despesas
                dados.despesas.push({
                    id: 2001,
                    categoria: 'insumos',
                    descricao: 'Materiais cirurgicos',
                    valor: 1200,
                    data: '2024-06-16'
                });

                dados.despesas.push({
                    id: 2002,
                    categoria: 'gasolina',
                    descricao: 'Combustivel do mes',
                    valor: 800,
                    data: '2024-06-18'
                });

                // Insumos (PRIMEIRO para poder usar nas cirurgias)
                dados.insumos.push({
                    id: 7001,
                    nome: 'Seringa 5ml',
                    categoria: 'descartaveis',
                    quantidade: 50,
                    unidade: 'unidade',
                    preco: 0.85,
                    estoqueMinimo: 20
                });

                dados.insumos.push({
                    id: 7002,
                    nome: 'Lubrificante Ocular',
                    categoria: 'medicamentos',
                    quantidade: 15,
                    unidade: 'frasco',
                    preco: 15.50,
                    estoqueMinimo: 10
                });

                dados.insumos.push({
                    id: 7003,
                    nome: 'Gaze Estéril',
                    categoria: 'descartaveis',
                    quantidade: 30,
                    unidade: 'pacote',
                    preco: 3.20,
                    estoqueMinimo: 15
                });

                dados.insumos.push({
                    id: 7004,
                    nome: 'Lente Intraocular',
                    categoria: 'equipamentos',
                    quantidade: 8,
                    unidade: 'unidade',
                    preco: 450.00,
                    estoqueMinimo: 5
                });

                // Cirurgias (com insumos e cálculos completos)
                dados.cirurgias.push({
                    id: 3001,
                    tipo: 'catarata',
                    paciente: 'Maria Santos',
                    valorBruto: 4000,
                    formaPagamento: 'cartao-credito-vista',
                    taxaCartao: 3.5,
                    taxaCartaoValor: 140, // 4000 * 3.5%
                    impostos: 720, // 4000 * 18%
                    comissaoOrientadora: 120, // 4000 * 3%
                    valorInstrumentadora: 200,
                    custoFuncionarios: 150,
                    outrosCustos: 0,
                    custoInsumos: 470.40,
                    totalCustosOperacionais: 470, // 120 + 200 + 150
                    totalCustos: 1800.40, // 140 + 720 + 120 + 200 + 150 + 470.40
                    valorLiquido: 2199.60, // 4000 - 1800.40
                    margem: 54.99, // (2199.60 / 4000) * 100
                    data: '2024-06-15',
                    status: 'realizada',
                    observacoes: 'Cirurgia sem complicações',
                    insumosUtilizados: [
                        { id: 7004, nome: 'Lente Intraocular', quantidade: 1, preco: 450.00, unidade: 'unidade', total: 450.00 },
                        { id: 7001, nome: 'Seringa 5ml', quantidade: 4, preco: 0.85, unidade: 'unidade', total: 3.40 },
                        { id: 7002, nome: 'Lubrificante Ocular', quantidade: 1, preco: 15.50, unidade: 'frasco', total: 15.50 },
                        { id: 7003, nome: 'Gaze Estéril', quantidade: 1, preco: 3.20, unidade: 'pacote', total: 1.50 }
                    ]
                });

                dados.cirurgias.push({
                    id: 3002,
                    tipo: 'retina',
                    paciente: 'José Oliveira',
                    valorBruto: 6000,
                    formaPagamento: 'dinheiro',
                    taxaCartao: 0,
                    taxaCartaoValor: 0,
                    impostos: 1080, // 6000 * 18%
                    comissaoOrientadora: 180, // 6000 * 3%
                    valorInstrumentadora: 200,
                    custoFuncionarios: 150,
                    outrosCustos: 50, // Taxa extra anestesista
                    custoInsumos: 35.20,
                    totalCustosOperacionais: 580, // 180 + 200 + 150 + 50
                    totalCustos: 1845.20, // 0 + 1080 + 180 + 200 + 150 + 35.20 + 50
                    valorLiquido: 4154.80, // 6000 - 1845.20
                    margem: 69.25, // (4154.80 / 6000) * 100
                    data: '2024-06-25',
                    status: 'agendada',
                    observacoes: 'Paciente em jejum - Anestesista extra',
                    insumosUtilizados: [
                        { id: 7001, nome: 'Seringa 5ml', quantidade: 6, preco: 0.85, unidade: 'unidade', total: 5.10 },
                        { id: 7002, nome: 'Lubrificante Ocular', quantidade: 2, preco: 15.50, unidade: 'frasco', total: 31.00 },
                        { id: 7003, nome: 'Gaze Estéril', quantidade: 2, preco: 3.20, unidade: 'pacote', total: 6.40 }
                    ]
                });

                dados.cirurgias.push({
                    id: 3003,
                    tipo: 'pterígio',
                    paciente: 'Ana Costa',
                    valorBruto: 1500,
                    formaPagamento: 'cartao-debito',
                    taxaCartao: 1.5,
                    taxaCartaoValor: 22.50, // 1500 * 1.5%
                    impostos: 270, // 1500 * 18%
                    comissaoOrientadora: 45, // 1500 * 3%
                    valorInstrumentadora: 200,
                    custoFuncionarios: 150,
                    outrosCustos: 0,
                    custoInsumos: 8.90,
                    totalCustosOperacionais: 395, // 45 + 200 + 150
                    totalCustos: 696.40, // 22.50 + 270 + 45 + 200 + 150 + 8.90
                    valorLiquido: 803.60, // 1500 - 696.40
                    margem: 53.57, // (803.60 / 1500) * 100
                    data: '2024-06-20',
                    status: 'realizada',
                    observacoes: 'Procedimento simples - rápido',
                    insumosUtilizados: [
                        { id: 7001, nome: 'Seringa 5ml', quantidade: 2, preco: 0.85, unidade: 'unidade', total: 1.70 },
                        { id: 7003, nome: 'Gaze Estéril', quantidade: 2, preco: 3.20, unidade: 'pacote', total: 6.40 },
                        { id: 7002, nome: 'Lubrificante Ocular', quantidade: 1, preco: 0.80, unidade: 'frasco', total: 0.80 }
                    ]
                });
                
                // Adicionar receitas para as cirurgias realizadas de exemplo
                dados.receitas.push({
                    id: 300101,
                    fonte: 'cirurgias',
                    descricao: 'Líquido da Cirurgia: Maria Santos (catarata)',
                    valor: 2199.60,
                    data: '2024-06-15'
                });
                 dados.receitas.push({
                    id: 300301,
                    fonte: 'cirurgias',
                    descricao: 'Líquido da Cirurgia: Ana Costa (pterígio)',
                    valor: 803.60,
                    data: '2024-06-20'
                });


                // Funcionários (ANTES das cirurgias para calcular custos)
                dados.funcionarios.push({
                    id: 4001,
                    nome: 'Ana Paula Enfermeira',
                    cargo: 'enfermeiro',
                    tipoPagamento: 'mensal',
                    salario: 3500,
                    dataAdmissao: '2023-01-15',
                    status: 'ativo'
                });

                dados.funcionarios.push({
                    id: 4002,
                    nome: 'Carlos Recepcionista',
                    cargo: 'recepcionista',
                    tipoPagamento: 'mensal',
                    salario: 2800,
                    dataAdmissao: '2023-03-01',
                    status: 'ativo'
                });

                dados.funcionarios.push({
                    id: 4003,
                    nome: 'João Auxiliar Cirurgia',
                    cargo: 'auxiliar',
                    tipoPagamento: 'diario',
                    valorDiario: 80,
                    dataAdmissao: '2024-01-10',
                    status: 'ativo'
                });

                dados.funcionarios.push({
                    id: 4004,
                    nome: 'Maria Técnica',
                    cargo: 'tecnico',
                    tipoPagamento: 'diario',
                    valorDiario: 70,
                    dataAdmissao: '2024-02-15',
                    status: 'ativo'
                });

                // Gastos Fixos
                dados.gastosFixos.push({
                    id: 5001,
                    descricao: 'Aluguel Consultório',
                    categoria: 'aluguel',
                    valor: 4500,
                    diaVencimento: 10
                });

                dados.gastosFixos.push({
                    id: 5002,
                    descricao: 'Energia Elétrica',
                    categoria: 'energia',
                    valor: 800,
                    diaVencimento: 15
                });

                // Parcelas
                dados.parcelas.push({
                    id: 6001,
                    tipo: 'pagar',
                    descricao: 'Financiamento Equipamento',
                    valor: 1200,
                    numeroParcelas: 12, // Exemplo
                    dataVencimento: '2024-06-30',
                    status: 'pendente'
                });

                dados.parcelas.push({
                    id: 6002,
                    tipo: 'receber',
                    descricao: 'Plano de Saúde - Consultas',
                    valor: 2500,
                    numeroParcelas: 3, // Exemplo
                    dataVencimento: '2024-06-28',
                    status: 'pendente'
                });

                // Ajustar estoque após cirurgias realizadas
                // Subtrair insumos usados na cirurgia da Maria Santos (realizada)
                dados.insumos[0].quantidade -= 4; // Seringa 5ml: 50 - 4 = 46
                dados.insumos[1].quantidade -= 1; // Lubrificante: 15 - 1 = 14  
                dados.insumos[2].quantidade -= 1; // Gaze: 30 - 1 = 29
                dados.insumos[3].quantidade -= 1; // Lente: 8 - 1 = 7

                // Subtrair insumos da Ana Costa (realizada)
                dados.insumos[0].quantidade -= 2; // Seringa: 46 - 2 = 44
                dados.insumos[2].quantidade -= 2; // Gaze: 29 - 2 = 27
                
                // Atualizar todas as visualizações
                atualizarTodasAsVisualizacoes();
                
                // Salvamento automático
                salvarAutomatico();
                mostrarNotificacao('🎯 Dados de exemplo adicionados com sucesso! Explore todas as abas para ver as funcionalidades.', 'success');
            }
        }

        // === FUNÇÕES PARA CIRURGIAS ===
        function atualizarListaCirurgias() {
            var container = document.getElementById('listaCirurgias');
            if (dados.cirurgias.length === 0) {
                container.innerHTML = '<div class="transaction-item"><div class="transaction-info"><div>Nenhuma cirurgia registrada ainda</div></div></div>';
            } else {
                var html = '';
                dados.cirurgias.forEach(function(cirurgia) {
                    var statusClass = cirurgia.status === 'realizada' ? 'status-pago' : 
                                    cirurgia.status === 'agendada' ? 'status-pendente' : 'status-cancelada';
                    var margemClass = cirurgia.margem >= 50 ? 'margem-alta' : 
                                    cirurgia.margem >= 30 ? 'margem-media' : 'margem-baixa';
                    
                    html += '<div class="transaction-item">';
                    html += '<div class="transaction-info">';
                    html += '<div><strong>' + cirurgia.paciente + '</strong> - ' + cirurgia.tipo + '</div>';
                    html += '<div class="transaction-date">' + formatarData(cirurgia.data) + ' | ' + (cirurgia.formaPagamento || 'N/A') + '</div>';
                    html += '<div style="font-size: 0.85em; color: #666; margin-top: 3px;">';
                    html += 'Bruto: ' + formatarMoeda(cirurgia.valorBruto || cirurgia.valor || 0) + ' | ';
                    html += 'Custos: ' + formatarMoeda(cirurgia.totalCustos || 0) + ' | ';
                    html += 'Líquido: ' + formatarMoeda(cirurgia.valorLiquido || cirurgia.valor || 0);
                    html += '</div>';
                    html += '<div style="font-size: 0.85em; margin-top: 2px;">';
                    html += '<span class="' + margemClass + '">Margem: ' + ((cirurgia.margem || 0).toFixed(1)) + '%</span>';
                    html += '</div>';
                    html += '<div style="margin-top: 5px;"><span class="' + statusClass + '">' + cirurgia.status.toUpperCase() + '</span></div>';
                    html += '</div>';
                    html += '<div style="text-align: right;">';
                    html += '<div class="transaction-value receita">' + formatarMoeda(cirurgia.valorLiquido || cirurgia.valor || 0) + '</div>';
                    html += '<button class="btn" style="font-size: 10px; padding: 3px 8px; margin: 2px;" onclick="verDetalhesCirurgia(' + cirurgia.id + ')">Ver Detalhes</button>';
                    html += '</div>';
                    html += '<button class="delete-btn" onclick="excluirCirurgia(' + cirurgia.id + ')">Excluir</button>';
                    html += '</div>';
                });
                container.innerHTML = html;
            }
        }

        function atualizarResumoCirurgias() {
            var realizadas = dados.cirurgias.filter(c => c.status === 'realizada').length;
            var agendadas = dados.cirurgias.filter(c => c.status === 'agendada').length;
            var faturamentoBruto = dados.cirurgias.filter(c => c.status === 'realizada').reduce((total, c) => total + parseFloat(c.valorBruto || c.valor || 0), 0);
            var faturamentoLiquido = dados.cirurgias.filter(c => c.status === 'realizada').reduce((total, c) => total + parseFloat(c.valorLiquido || c.valor || 0), 0);
            var margemMedia = realizadas > 0 ? dados.cirurgias.filter(c => c.status === 'realizada').reduce((total, c) => total + (c.margem || 0), 0) / realizadas : 0;
            
            document.getElementById('cirurgiasRealizadas').textContent = realizadas;
            document.getElementById('cirurgiasAgendadas').textContent = agendadas;
            document.getElementById('faturamentoBruto').textContent = formatarMoeda(faturamentoBruto);
            document.getElementById('faturamentoLiquido').textContent = formatarMoeda(faturamentoLiquido);
            document.getElementById('margemMedia').textContent = margemMedia.toFixed(1) + '%';
            
            // Manter compatibilidade com o dashboard
            if (document.getElementById('faturamentoCirurgias')) {
                document.getElementById('faturamentoCirurgias').textContent = formatarMoeda(faturamentoLiquido);
            }
        }

        function verDetalhesCirurgia(id) {
            var cirurgia = dados.cirurgias.find(c => c.id === id);
            if (!cirurgia) return;
            
            var detalhes = 'DETALHES COMPLETOS DA CIRURGIA\n\n';
            detalhes += 'Paciente: ' + cirurgia.paciente + '\n';
            detalhes += 'Tipo: ' + cirurgia.tipo + '\n';
            detalhes += 'Data: ' + formatarData(cirurgia.data) + '\n';
            detalhes += 'Status: ' + cirurgia.status + '\n\n';
            
            detalhes += 'RECEITA:\n';
            detalhes += 'Valor Bruto: ' + formatarMoeda(cirurgia.valorBruto || cirurgia.valor || 0) + '\n';
            detalhes += 'Forma Pagamento: ' + (cirurgia.formaPagamento || 'N/A') + '\n\n';
            
            detalhes += 'CUSTOS DETALHADOS:\n';
            detalhes += '• Taxa Cartão: ' + formatarMoeda(cirurgia.taxaCartaoValor || 0) + '\n';
            detalhes += '• Impostos (18%): ' + formatarMoeda(cirurgia.impostos || 0) + '\n';
            detalhes += '• Comissão Orientadora: ' + formatarMoeda(cirurgia.comissaoOrientadora || 0) + '\n';
            detalhes += '• Instrumentadora: ' + formatarMoeda(cirurgia.valorInstrumentadora || 0) + '\n';
            detalhes += '• Funcionários/Dia: ' + formatarMoeda(cirurgia.custoFuncionarios || 0) + '\n';
            detalhes += '• Custo Insumos: ' + formatarMoeda(cirurgia.custoInsumos || 0) + '\n';
            if (cirurgia.outrosCustos && cirurgia.outrosCustos > 0) {
                detalhes += '• Outros Custos: ' + formatarMoeda(cirurgia.outrosCustos) + '\n';
            }
            detalhes += '-----------------------------------\n';
            detalhes += 'TOTAL DE CUSTOS: ' + formatarMoeda(cirurgia.totalCustos || 0) + '\n\n';
            
            detalhes += 'RESULTADO:\n';
            detalhes += 'Valor Líquido: ' + formatarMoeda(cirurgia.valorLiquido || cirurgia.valor || 0) + '\n';
            detalhes += 'Margem: ' + ((cirurgia.margem || 0).toFixed(1)) + '%\n\n';
            
            if (cirurgia.insumosUtilizados && cirurgia.insumosUtilizados.length > 0) {
                detalhes += 'INSUMOS UTILIZADOS:\n';
                cirurgia.insumosUtilizados.forEach(function(insumo) {
                    detalhes += '• ' + insumo.nome + ': ' + insumo.quantidade + ' x ' + formatarMoeda(insumo.preco) + ' = ' + formatarMoeda(insumo.total) + '\n';
                });
                detalhes += '\n';
            }
            
            if (cirurgia.observacoes) {
                detalhes += 'OBSERVAÇÕES:\n' + cirurgia.observacoes;
            }
            
            alert(detalhes);
        }

        function carregarInsumosNoSelect() {
            var selects = document.querySelectorAll('.insumo-select');
            selects.forEach(function(select) {
                select.innerHTML = '<option value="">Selecione um insumo...</option>';
                dados.insumos.forEach(function(insumo) {
                    var option = document.createElement('option');
                    option.value = insumo.id;
                    option.textContent = insumo.nome + ' - ' + formatarMoeda(insumo.preco) + '/' + insumo.unidade + ' (Estoque: ' + insumo.quantidade + ')';
                    option.dataset.preco = insumo.preco;
                    option.dataset.nome = insumo.nome;
                    option.dataset.unidade = insumo.unidade;
                    option.dataset.estoque = insumo.quantidade;
                    select.appendChild(option);
                });
            });
        }

        function adicionarLinhaInsumo() {
            var container = document.getElementById('insumosUtilizados');
            var novaLinha = document.createElement('div');
            novaLinha.className = 'insumo-item';
            novaLinha.style.cssText = 'display: flex; gap: 10px; margin: 10px 0; align-items: center;';
            
            novaLinha.innerHTML = `
                <input type="text" class="codigo-barras-insumo" placeholder="Escaneie o código" style="flex: 2;">
                <select class="insumo-select" style="flex: 2;">
                    <option value="">Selecione um insumo...</option>
                </select>
                <input type="number" class="quantidade-insumo" placeholder="Qtd" style="width: 80px;" min="1">
                <span class="preco-insumo" style="width: 100px; font-weight: bold;"></span>
                <button type="button" class="btn-remover-insumo" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; flex-shrink: 0; margin-left: 5px;">Remover</button>
            `;
            
            container.appendChild(novaLinha);
            carregarInsumosNoSelect();
            configurarEventosInsumo(novaLinha);
        }

        function configurarEventosInsumo(linha) {
            var select = linha.querySelector('.insumo-select');
            var quantidade = linha.querySelector('.quantidade-insumo');
            var preco = linha.querySelector('.preco-insumo');
            var btnRemover = linha.querySelector('.btn-remover-insumo');
            
            
            
            var codigoInput = linha.querySelector('.codigo-barras-insumo');
            if (codigoInput) {
                codigoInput.addEventListener('input', function(e) {
                    var codigo = e.target.value.trim();
                    if (codigo.length > 2) {
                        carregarInsumosNoSelect();
                        var match = dados.insumos.find(function(i){ return String(i.codigoBarras || '') === String(codigo); });
                        if (match) {
                            select.value = match.id;
                            quantidade.value = quantidade.value || 1;
                            select.dispatchEvent(new Event('change'));
                        }
                    }
                });
                codigoInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        var codigo = e.target.value.trim();
                        if (codigo) {
                            carregarInsumosNoSelect();
                            var match = dados.insumos.find(function(i){ return String(i.codigoBarras || '') === String(codigo); });
                            if (match) {
                                select.value = match.id;
                                quantidade.value = quantidade.value || 1;
                                select.dispatchEvent(new Event('change'));
                            }
                        }
                    }
                });
            }
function atualizarPreco() {
                var option = select.options[select.selectedIndex];
                var qtd = parseInt(quantidade.value) || 0;
                var precoUnit = parseFloat(option.dataset.preco) || 0;
                var total = qtd * precoUnit;
                
                if (qtd > 0 && precoUnit > 0) {
                    preco.textContent = formatarMoeda(total);
                } else {
                    preco.textContent = '';
                }
                
                calcularResumoFinanceiro();
            }
            
            select.addEventListener('change', atualizarPreco);
            quantidade.addEventListener('input', atualizarPreco);
            
            btnRemover.addEventListener('click', function() {
                linha.remove();
                calcularResumoFinanceiro();
            });
        }

        function calcularResumoFinanceiro() {
            var valorBruto = parseFloat(document.getElementById('valorBrutoCirurgia').value) || 0;
            var formaPagamento = document.getElementById('formaPagamentoCirurgia').value;
            var taxaCartao = parseFloat(document.getElementById('taxaCartaoCirurgia').value) || 0;
            
            // Custos operacionais
            var comissaoPerc = parseFloat(document.getElementById('comissaoOrientadora').value) || 0;
            var valorInstrumentadora = parseFloat(document.getElementById('valorInstrumentadora').value) || 0;
            var outrosCustos = parseFloat(document.getElementById('outrosCustos').value) || 0;
            
            // Calcular custo dos funcionários por dia (automático da aba funcionários)
            var custoFuncionariosDia = calcularCustoFuncionariosDia();
            
            // Calcular total de insumos
            var totalInsumos = 0;
            var linhasInsumos = document.querySelectorAll('.insumo-item');
            linhasInsumos.forEach(function(linha) {
                var select = linha.querySelector('.insumo-select');
                var quantidade = linha.querySelector('.quantidade-insumo');
                
                if (select.value && quantidade.value) {
                    var option = select.options[select.selectedIndex];
                    var precoUnit = parseFloat(option.dataset.preco) || 0;
                    var qtd = parseInt(quantidade.value) || 0;
                    totalInsumos += precoUnit * qtd;
                }
            });
            
            // Calcular descontos e custos
            var taxaCartaoValor = 0;
            if (formaPagamento.includes('cartao') && taxaCartao > 0) {
                taxaCartaoValor = valorBruto * (taxaCartao / 100);
            }
            
            var impostos = valorBruto * 0.18; // 18% fixo
            var comissaoOrientadora = valorBruto * (comissaoPerc / 100);
            var totalCustosOperacionais = comissaoOrientadora + valorInstrumentadora + custoFuncionariosDia + outrosCustos;
            var totalCustos = taxaCartaoValor + impostos + comissaoOrientadora + valorInstrumentadora + custoFuncionariosDia + totalInsumos + outrosCustos;
            var valorLiquido = valorBruto - totalCustos;
            var margem = valorBruto > 0 ? ((valorLiquido / valorBruto) * 100) : 0;
            
            // Atualizar interface
            document.getElementById('totalInsumos').innerHTML = '<strong>' + formatarMoeda(totalInsumos) + '</strong>';
            document.getElementById('valorComissaoOrientadora').innerHTML = '<strong>' + formatarMoeda(comissaoOrientadora) + '</strong>';
            document.getElementById('custoFuncionariosDia').innerHTML = '<strong>' + formatarMoeda(custoFuncionariosDia) + '</strong>';
            document.getElementById('totalCustosOperacionais').innerHTML = '<strong>' + formatarMoeda(totalCustosOperacionais) + '</strong>';
            
            document.getElementById('resumoValorBruto').textContent = formatarMoeda(valorBruto);
            document.getElementById('resumoTaxaCartao').textContent = formatarMoeda(taxaCartaoValor);
            document.getElementById('resumoImpostos').textContent = formatarMoeda(impostos);
            document.getElementById('resumoComissaoOrientadora').textContent = formatarMoeda(comissaoOrientadora);
            document.getElementById('resumoInstrumentadora').textContent = formatarMoeda(valorInstrumentadora);
            document.getElementById('resumoFuncionarios').textContent = formatarMoeda(custoFuncionariosDia);
            document.getElementById('resumoCustoInsumos').textContent = formatarMoeda(totalInsumos);
            document.getElementById('resumoOutrosCustos').textContent = formatarMoeda(outrosCustos);
            document.getElementById('resumoTotalCustos').innerHTML = '<strong>' + formatarMoeda(totalCustos) + '</strong>';
            document.getElementById('resumoValorLiquido').innerHTML = '<strong>' + formatarMoeda(valorLiquido) + '</strong>';
            document.getElementById('resumoMargem').innerHTML = '<strong>' + margem.toFixed(1) + '%</strong>';
            
            // Aplicar cores baseadas na margem (ajustado para custos reais)
            var corMargem = margem >= 50 ? '#28a745' : margem >= 30 ? '#ffc107' : '#dc3545';
            document.getElementById('resumoValorLiquido').style.color = valorLiquido >= 0 ? '#28a745' : '#dc3545';
            document.getElementById('resumoMargem').style.color = corMargem;
        }

        function calcularCustoFuncionariosDia() {
            // Calcular automaticamente o custo dos funcionários que trabalham por dia
            var custoTotal = 0;
            dados.funcionarios.forEach(function(funcionario) {
                if (funcionario.status === 'ativo' && funcionario.tipoPagamento === 'diario') {
                    custoTotal += parseFloat(funcionario.valorDiario || 0);
                }
            });
            return custoTotal;
        }

        function processarCirurgia(dadosCirurgia) {
            // Coletar insumos utilizados
            var insumosUtilizados = [];
            var totalInsumos = 0;
            
            var linhasInsumos = document.querySelectorAll('.insumo-item');
            linhasInsumos.forEach(function(linha) {
                var select = linha.querySelector('.insumo-select');
                var quantidade = linha.querySelector('.quantidade-insumo');
                
                if (select.value && quantidade.value) {
                    var option = select.options[select.selectedIndex];
                    var insumoId = parseInt(select.value);
                    var qtd = parseInt(quantidade.value);
                    var precoUnit = parseFloat(option.dataset.preco);
                    var total = precoUnit * qtd;
                    
                    insumosUtilizados.push({
                        id: insumoId,
                        nome: option.dataset.nome,
                        quantidade: qtd,
                        preco: precoUnit,
                        unidade: option.dataset.unidade,
                        total: total
                    });
                    
                    totalInsumos += total;
                    
                    // Descontar do estoque se a cirurgia foi realizada
                    if (dadosCirurgia.status === 'realizada') {
                        var insumo = dados.insumos.find(i => i.id === insumoId);
                        if (insumo) {
                            insumo.quantidade = Math.max(0, insumo.quantidade - qtd);
                        }
                    }
                }
            });
            
            // Calcular valores
            var valorBruto = dadosCirurgia.valorBruto;
            var taxaCartaoValor = 0;
            
            if (dadosCirurgia.formaPagamento.includes('cartao') && dadosCirurgia.taxaCartao > 0) {
                taxaCartaoValor = valorBruto * (dadosCirurgia.taxaCartao / 100);
            }
            
            var impostos = valorBruto * 0.18;
            var comissaoOrientadora = valorBruto * ((dadosCirurgia.comissaoOrientadora || 3) / 100);
            var valorInstrumentadora = dadosCirurgia.valorInstrumentadora || 200;
            var custoFuncionarios = calcularCustoFuncionariosDia(); // Cálculo automático
            var outrosCustos = dadosCirurgia.outrosCustos || 0;
            
            var totalCustosOperacionais = comissaoOrientadora + valorInstrumentadora + custoFuncionarios + outrosCustos;
            var totalCustos = taxaCartaoValor + impostos + comissaoOrientadora + valorInstrumentadora + custoFuncionarios + totalInsumos + outrosCustos;
            var valorLiquido = valorBruto - totalCustos;
            var margem = valorBruto > 0 ? ((valorLiquido / valorBruto) * 100) : 0;
            
            // Estrutura completa da cirurgia
            return {
                ...dadosCirurgia,
                insumosUtilizados: insumosUtilizados,
                custoInsumos: totalInsumos,
                comissaoOrientadora: comissaoOrientadora,
                valorInstrumentadora: valorInstrumentadora,
                custoFuncionarios: custoFuncionarios,
                outrosCustos: outrosCustos,
                totalCustosOperacionais: totalCustosOperacionais,
                taxaCartaoValor: taxaCartaoValor,
                impostos: impostos,
                totalCustos: totalCustos,
                valorLiquido: valorLiquido,
                margem: margem
            };
        }

        function excluirCirurgia(id) {
            if (!usuarioLogado) return;
            if (confirm('Tem certeza que deseja excluir esta cirurgia? Esta ação também removerá a receita associada a ela, se houver.')) {
                // Restaurar estoque se necessário
                var cirurgia = dados.cirurgias.find(c => c.id === id);
                if (cirurgia && cirurgia.status === 'realizada' && cirurgia.insumosUtilizados) {
                    cirurgia.insumosUtilizados.forEach(function(insumoUtilizado) {
                        var insumo = dados.insumos.find(i => i.id === insumoUtilizado.id);
                        if (insumo) {
                            insumo.quantidade += insumoUtilizado.quantidade;
                        }
                    });
                }
                
                // Excluir a receita correspondente
                const descReceita = `Líquido da Cirurgia: ${cirurgia.paciente} (${cirurgia.tipo})`;
                dados.receitas = dados.receitas.filter(r => r.descricao !== descReceita);

                // Excluir a cirurgia
                dados.cirurgias = dados.cirurgias.filter(c => c.id !== id);

                atualizarTodasAsVisualizacoes();
                
                // Salvamento automático
                salvarAutomatico();
                mostrarNotificacao('🗑️ Cirurgia e sua receita foram excluídas!', 'warning');
            }
        }

        // === FUNÇÕES PARA FUNCIONÁRIOS ===
        function atualizarListaFuncionarios() {
            var container = document.getElementById('listaFuncionarios');
            if (dados.funcionarios.length === 0) {
                container.innerHTML = '<div class="transaction-item"><div class="transaction-info"><div>Nenhum funcionário registrado ainda</div></div></div>';
            } else {
                var html = '';
                dados.funcionarios.forEach(function(funcionario) {
                    var statusClass = funcionario.status === 'ativo' ? 'status-pago' : 
                                    funcionario.status === 'ferias' ? 'status-pendente' : 'status-cancelada';
                    var tipoTexto = funcionario.tipoPagamento === 'mensal' ? 'Mensal' : 'Por Dia';
                    var valorTexto = funcionario.tipoPagamento === 'mensal' ? 
                                   formatarMoeda(funcionario.salario || 0) : 
                                   formatarMoeda(funcionario.valorDiario || 0) + '/dia';
                    
                    html += '<div class="transaction-item">';
                    html += '<div class="transaction-info">';
                    html += '<div><strong>' + funcionario.nome + '</strong> - ' + funcionario.cargo + '</div>';
                    html += '<div class="transaction-date">Admissão: ' + formatarData(funcionario.dataAdmissao) + ' | ' + tipoTexto + '</div>';
                    html += '<div style="margin-top: 5px;"><span class="' + statusClass + '">' + funcionario.status.toUpperCase() + '</span></div>';
                    html += '</div>';
                    html += '<div class="transaction-value ' + (funcionario.tipoPagamento === 'mensal' ? 'despesa' : 'receita') + '">' + valorTexto + '</div>';
                    html += '<button class="delete-btn" onclick="excluirFuncionario(' + funcionario.id + ')">Excluir</button>';
                    html += '</div>';
                });
                container.innerHTML = html;
            }
        }

        function atualizarResumoFuncionarios() {
            var ativos = dados.funcionarios.filter(f => f.status === 'ativo').length;
            var totalFolhaMensal = dados.funcionarios.filter(f => f.status === 'ativo' && f.tipoPagamento === 'mensal').reduce((total, f) => total + parseFloat(f.salario || 0), 0);
            var custoPorCirurgia = dados.funcionarios.filter(f => f.status === 'ativo' && f.tipoPagamento === 'diario').reduce((total, f) => total + parseFloat(f.valorDiario || 0), 0);
            
            document.getElementById('funcionariosAtivos').textContent = ativos;
            document.getElementById('totalFolha').textContent = formatarMoeda(totalFolhaMensal);
            document.getElementById('custoPorCirurgia').textContent = formatarMoeda(custoPorCirurgia);
        }

        function excluirFuncionario(id) {
            if (!usuarioLogado) return;
            if (confirm('Tem certeza que deseja excluir este funcionário?')) {
                dados.funcionarios = dados.funcionarios.filter(f => f.id !== id);
                atualizarListaFuncionarios();
                atualizarResumoFuncionarios();
                // Recalcular cirurgias se necessário
                calcularResumoFinanceiro();
                
                // Salvamento automático
                salvarAutomatico();
                mostrarNotificacao('🗑️ Funcionário excluído com sucesso!', 'warning');
            }
        }

        // === FUNÇÕES PARA GASTOS FIXOS ===
        function atualizarListaGastosFixos() {
            var container = document.getElementById('listaGastosFixos');
            if (dados.gastosFixos.length === 0) {
                container.innerHTML = '<div class="transaction-item"><div class="transaction-info"><div>Nenhum gasto fixo registrado ainda</div></div></div>';
            } else {
                var html = '';
                dados.gastosFixos.forEach(function(gasto) {
                    html += '<div class="transaction-item">';
                    html += '<div class="transaction-info">';
                    html += '<div><strong>' + gasto.descricao + '</strong></div>';
                    html += '<div class="transaction-date">' + gasto.categoria + ' - Vencimento dia ' + gasto.diaVencimento + '</div>';
                    html += '</div>';
                    html += '<div class="transaction-value despesa">' + formatarMoeda(gasto.valor) + '</div>';
                    html += '<button class="delete-btn" onclick="excluirGastoFixo(' + gasto.id + ')">Excluir</button>';
                    html += '</div>';
                });
                container.innerHTML = html;
            }
        }

        function atualizarResumoGastosFixos() {
            var total = dados.gastosFixos.reduce((total, g) => total + parseFloat(g.valor), 0);
            document.getElementById('totalGastosFixosDetalhado').innerHTML = '<strong>' + formatarMoeda(total) + '</strong>';
            document.getElementById('totalGastosFixos').textContent = formatarMoeda(total);
        }

        function excluirGastoFixo(id) {
            if (!usuarioLogado) return;
            if (confirm('Tem certeza que deseja excluir este gasto fixo?')) {
                dados.gastosFixos = dados.gastosFixos.filter(g => g.id !== id);
                atualizarListaGastosFixos();
                atualizarResumoGastosFixos();
                
                // Salvamento automático
                salvarAutomatico();
                mostrarNotificacao('🗑️ Gasto fixo excluído com sucesso!', 'warning');
            }
        }

        // === FUNÇÕES PARA PARCELAS ===
        function atualizarListaParcelas() {
            var container = document.getElementById('listaParcelas');
            if (dados.parcelas.length === 0) {
                container.innerHTML = '<div class="transaction-item"><div class="transaction-info"><div>Nenhuma parcela registrada ainda</div></div></div>';
            } else {
                var html = '';
                dados.parcelas.forEach(function(parcela) {
                    var statusClass = parcela.status === 'pago' ? 'status-pago' : 
                                    parcela.status === 'pendente' ? 'status-pendente' : 'status-cancelada';
                    var tipoClass = parcela.tipo === 'receber' ? 'receita' : 'despesa';
                    html += '<div class="transaction-item">';
                    html += '<div class="transaction-info">';
                    html += '<div><strong>' + parcela.descricao + '</strong></div>';
                    html += '<div class="transaction-date">Vencimento: ' + formatarData(parcela.dataVencimento) + ' | ' + parcela.tipo.toUpperCase();
                    // Adicionar número de parcelas se existir
                    if (parcela.numeroParcelas) {
                        html += ' | Parcelas: ' + parcela.numeroParcelas;
                    }
                    html += '</div>';
                    html += '<div style="margin-top: 5px;"><span class="' + statusClass + '">' + parcela.status.toUpperCase() + '</span></div>';
                    html += '</div>';
                    html += '<div class="transaction-value ' + tipoClass + '">' + formatarMoeda(parcela.valor) + '</div>';
                    html += '<button class="delete-btn" onclick="excluirParcela(' + parcela.id + ')">Excluir</button>';
                    html += '</div>';
                });
                container.innerHTML = html;
            }
        }

        function atualizarResumoParcelas() {
            var totalAPagar = dados.parcelas.filter(p => p.tipo === 'pagar' && p.status === 'pendente').reduce((total, p) => total + parseFloat(p.valor), 0);
            var totalAReceber = dados.parcelas.filter(p => p.tipo === 'receber' && p.status === 'pendente').reduce((total, p) => total + parseFloat(p.valor), 0);
            var totalParcelasRegistradas = dados.parcelas.length; // Novo: Contagem total de parcelas
            
            document.getElementById('totalAPagar').textContent = formatarMoeda(totalAPagar);
            document.getElementById('totalAReceber').textContent = formatarMoeda(totalAReceber);
            document.getElementById('totalParcelasRegistradas').textContent = totalParcelasRegistradas; // Atualiza o novo elemento
        }

        function excluirParcela(id) {
            if (!usuarioLogado) return;
            if (confirm('Tem certeza que deseja excluir esta parcela?')) {
                dados.parcelas = dados.parcelas.filter(p => p.id !== id);
                atualizarListaParcelas();
                atualizarResumoParcelas();
                
                // Salvamento automático
                salvarAutomatico();
                mostrarNotificacao('🗑️ Parcela excluída com sucesso!', 'warning');
            }
        }

        // === FUNÇÕES PARA INSUMOS ===
        function atualizarListaInsumos() {
            var container = document.getElementById('listaInsumos');
            if (dados.insumos.length === 0) {
                container.innerHTML = '<div class="transaction-item"><div class="transaction-info"><div>Nenhum insumo registrado ainda</div></div></div>';
            } else {
                var html = '';
                dados.insumos.forEach(function(insumo) {
                    var alertaEstoque = insumo.quantidade <= insumo.estoqueMinimo ? ' ⚠️' : '';
                    html += '<div class="transaction-item">';
                    html += '<div class="transaction-info">';
                    html += '<div><strong>' + insumo.nome + '</strong>' + alertaEstoque + '</div>';
                    html += '<div class="transaction-date">' + insumo.categoria + ' | Estoque: ' + insumo.quantidade + ' ' + insumo.unidade + '</div>';
                    html += '</div>';
                    html += '<div class="transaction-value">' + formatarMoeda(insumo.preco) + '/' + insumo.unidade + '</div>';
                    html += '<button class="delete-btn" onclick="excluirInsumo(' + insumo.id + ')">Excluir</button>';
                    html += '</div>';
                });
                container.innerHTML = html;
            }
        }

        function atualizarResumoInsumos() {
            var totalItens = dados.insumos.length;
            var itensEmFalta = dados.insumos.filter(i => i.quantidade <= i.estoqueMinimo).length;
            
            document.getElementById('totalItens').textContent = totalItens;
            document.getElementById('itensEmFalta').textContent = itensEmFalta;
        }

        function excluirInsumo(id) {
            if (!usuarioLogado) return;
            if (confirm('Tem certeza que deseja excluir este insumo?')) {
                dados.insumos = dados.insumos.filter(i => i.id !== id);
                atualizarListaInsumos();
                atualizarResumoInsumos();
                
                // Salvamento automático
                salvarAutomatico();
                mostrarNotificacao('🗑️ Insumo excluído com sucesso!', 'warning');
            }
        }

        // === FUNÇÕES PARA RELATÓRIOS ===
        function gerarRelatorio() {
            if (!usuarioLogado) return;
            
            var periodo = document.getElementById('periodoRelatorio').value;
            var dataInicial, dataFinal;
            var hoje = new Date();
            
            switch(periodo) {
                case 'mes-atual':
                    dataInicial = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                    dataFinal = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                    break;
                case 'mes-anterior':
                    dataInicial = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
                    dataFinal = new Date(hoje.getFullYear(), hoje.getMonth(), 0);
                    break;
                case 'trimestre':
                    dataInicial = new Date(hoje.getFullYear(), hoje.getMonth() - 2, 1);
                    dataFinal = hoje;
                    break;
                case 'semestre':
                    dataInicial = new Date(hoje.getFullYear(), hoje.getMonth() - 5, 1);
                    dataFinal = hoje;
                    break;
                case 'ano':
                    dataInicial = new Date(hoje.getFullYear() - 1, hoje.getMonth(), hoje.getDate());
                    dataFinal = hoje;
                    break;
                case 'personalizado':
                    dataInicial = new Date(document.getElementById('dataInicial').value);
                    dataFinal = new Date(document.getElementById('dataFinal').value);
                    break;
            }
            
            var relatorio = gerarRelatorioDetalhado(dataInicial, dataFinal);
            document.getElementById('relatorioConteudo').innerHTML = relatorio;
        }

        function gerarRelatorioDetalhado(dataInicial, dataFinal) {
            var formatoData = dataInicial.toISOString().slice(0, 10);
            var formatoDataFinal = dataFinal.toISOString().slice(0, 10);
            
            // Filtrar dados por período
            var receitasPeriodo = dados.receitas.filter(r => r.data >= formatoData && r.data <= formatoDataFinal);
            var despesasPeriodo = dados.despesas.filter(d => d.data >= formatoData && d.data <= formatoDataFinal);
            var cirurgiasPeriodo = dados.cirurgias.filter(c => c.data >= formatoData && c.data <= formatoDataFinal && c.status === 'realizada');
            
            var totalReceitas = receitasPeriodo.reduce((total, r) => total + parseFloat(r.valor), 0);
            var totalDespesas = despesasPeriodo.reduce((total, d) => total + parseFloat(d.valor), 0);
            var faturamentoBrutoCirurgias = cirurgiasPeriodo.reduce((total, c) => total + parseFloat(c.valorBruto), 0);
            var faturamentoLiquidoCirurgias = cirurgiasPeriodo.reduce((total, c) => total + parseFloat(c.valorLiquido), 0);
            var resultado = totalReceitas - totalDespesas;
            
            var html = '<h4>Relatório Financeiro - ' + formatarData(formatoData) + ' a ' + formatarData(formatoDataFinal) + '</h4>';
            html += '<div class="valor-detalhado"><span><strong>Total de Receitas (Geral):</strong></span><span><strong>' + formatarMoeda(totalReceitas) + '</strong></span></div>';
            html += '<div class="valor-detalhado"><span><strong>Total de Despesas (Geral):</strong></span><span><strong>' + formatarMoeda(totalDespesas) + '</strong></span></div>';
            html += '<hr>';
            html += '<div class="valor-detalhado"><span><strong>Resultado Líquido (Receitas - Despesas):</strong></span><span style="color: ' + (resultado >= 0 ? '#28a745' : '#dc3545') + ';"><strong>' + formatarMoeda(resultado) + '</strong></span></div>';
            
            html += '<h5 style="margin-top: 20px;">Resumo de Cirurgias no Período</h5>';
            html += '<div class="valor-detalhado"><span>Nº de Cirurgias Realizadas:</span><span>' + cirurgiasPeriodo.length + '</span></div>';
            html += '<div class="valor-detalhado"><span>Faturamento Bruto (Cirurgias):</span><span>' + formatarMoeda(faturamentoBrutoCirurgias) + '</span></div>';
            html += '<div class="valor-detalhado"><span>Faturamento Líquido (Cirurgias):</span><span>' + formatarMoeda(faturamentoLiquidoCirurgias) + '</span></div>';
            
            html += '<h5 style="margin-top: 20px;">Resumo por Categoria:</h5>';
            
            // Agrupar receitas por fonte
            var receitasPorFonte = {};
            receitasPeriodo.forEach(r => {
                receitasPorFonte[r.fonte] = (receitasPorFonte[r.fonte] || 0) + parseFloat(r.valor);
            });
            
            html += '<strong>Receitas:</strong><br>';
            for(var fonte in receitasPorFonte) {
                html += '<div class="valor-detalhado"><span>' + fonte + ':</span><span>' + formatarMoeda(receitasPorFonte[fonte]) + '</span></div>';
            }
            
            // Agrupar despesas por categoria
            var despesasPorCategoria = {};
            despesasPeriodo.forEach(d => {
                despesasPorCategoria[d.categoria] = (despesasPorCategoria[d.categoria] || 0) + parseFloat(d.valor);
            });
            
            html += '<br><strong>Despesas:</strong><br>';
            for(var categoria in despesasPorCategoria) {
                html += '<div class="valor-detalhado"><span>' + categoria + ':</span><span>' + formatarMoeda(despesasPorCategoria[categoria]) + '</span></div>';
            }
            
            return html;
        }

        function exportarDados(tipo) {
            if (!usuarioLogado) return;
            alert('Funcionalidade de exportação em desenvolvimento. Dados de ' + tipo + ' seriam exportados aqui.');
        }

        // Função para mostrar/ocultar período personalizado
        document.addEventListener('change', function(e) {
            if (e.target.id === 'periodoRelatorio') {
                var personalizado = document.getElementById('periodoPersonalizado');
                if (e.target.value === 'personalizado') {
                    personalizado.style.display = 'block';
                } else {
                    personalizado.style.display = 'none';
                }
            }
        });

        function limparTodosDados() {
            if (!usuarioLogado) return;
            
            if (confirm('⚠️ ATENÇÃO: Esta ação irá excluir todos os dados salvos permanentemente!\n\nDeseja continuar?')) {
                if (confirm('🚨 ÚLTIMA CONFIRMAÇÃO: Todos os dados serão perdidos. Tem certeza absoluta?')) {
                    dados = {
                        receitas: [],
                        despesas: [],
                        cirurgias: [],
                        funcionarios: [],
                        gastosFixos: [],
                        parcelas: [],
                        insumos: [],
                        saldoAtual: 0
                    };
                    
                    // Limpar dados salvos
                    localStorage.removeItem('sistemaFinanceiro_dados');
                    localStorage.removeItem('sistemaFinanceiro_ultimoSalvamento');
                    
                    atualizarTodasAsVisualizacoes();
                    atualizarStatusSalvamento();
                    mostrarNotificacao('🗑️ Todos os dados foram limpos!', 'warning');
                }
            }
        }

        function excluirReceita(id) {
            if (!usuarioLogado) return;
            
            const receita = dados.receitas.find(r => r.id === id);
            if (receita && receita.descricao.includes('Líquido da Cirurgia')) {
                alert('Esta receita foi gerada por uma cirurgia. Para removê-la, por favor, exclua a cirurgia correspondente na aba "Cirurgias".');
                return;
            }

            if (confirm('Tem certeza que deseja excluir esta receita?')) {
                dados.receitas = dados.receitas.filter(function(receita) {
                    return receita.id !== id;
                });
                atualizarTodasAsVisualizacoes();
                
                // Salvamento automático
                salvarAutomatico();
                mostrarNotificacao('🗑️ Receita excluída com sucesso!', 'warning');
            }
        }

        function excluirDespesa(id) {
            if (!usuarioLogado) return;
            
            if (confirm('Tem certeza que deseja excluir esta despesa?')) {
                dados.despesas = dados.despesas.filter(function(despesa) {
                    return despesa.id !== id;
                });
                atualizarTodasAsVisualizacoes();
                
                // Salvamento automático
                salvarAutomatico();
                mostrarNotificacao('🗑️ Despesa excluída com sucesso!', 'warning');
            }
        }

        // === EVENT LISTENERS ===
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            realizarLogin();
        });

        // Form de receitas
        document.getElementById('formReceita').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!usuarioLogado) return;
            
            var formData = new FormData(e.target);
            
            var receita = {
                id: Date.now(),
                fonte: formData.get('fonte'),
                descricao: formData.get('descricao'),
                valor: parseFloat(formData.get('valor')),
                data: formData.get('data')
            };

            dados.receitas.push(receita);
            
            e.target.reset();
            e.target.querySelector('input[type="date"]').value = new Date().toISOString().slice(0, 10);
            atualizarTodasAsVisualizacoes();
            
            // Salvamento automático
            salvarAutomatico();
            mostrarNotificacao('💰 Receita adicionada com sucesso!', 'success');
        });

        // Form de despesas
        document.getElementById('formDespesa').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!usuarioLogado) return;
            
            var formData = new FormData(e.target);
            
            var despesa = {
                id: Date.now(),
                categoria: formData.get('categoria'),
                descricao: formData.get('descricao'),
                valor: parseFloat(formData.get('valor')),
                data: formData.get('data')
            };

            dados.despesas.push(despesa);
            
            e.target.reset();
            e.target.querySelector('input[type="date"]').value = new Date().toISOString().slice(0, 10);
            atualizarTodasAsVisualizacoes();
            
            // Salvamento automático
            salvarAutomatico();
            mostrarNotificacao('💸 Despesa adicionada com sucesso!', 'success');
        });

        // Form de cirurgias
        document.getElementById('formCirurgia').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!usuarioLogado) return;
            
            var formData = new FormData(e.target);
            
            var dadosBasicos = {
                id: Date.now(),
                tipo: formData.get('tipo'),
                paciente: formData.get('paciente'),
                valorBruto: parseFloat(formData.get('valorBruto')),
                formaPagamento: formData.get('formaPagamento'),
                taxaCartao: parseFloat(formData.get('taxaCartao')) || 0,
                comissaoOrientadora: parseFloat(formData.get('comissaoOrientadora')) || 3,
                valorInstrumentadora: parseFloat(formData.get('valorInstrumentadora')) || 200,
                outrosCustos: parseFloat(formData.get('outrosCustos')) || 0,
                data: formData.get('data'),
                status: formData.get('status'),
                observacoes: formData.get('observacoes')
            };
            
            // Processar cirurgia com cálculos automáticos
            var cirurgia = processarCirurgia(dadosBasicos);
            dados.cirurgias.push(cirurgia);

            // ================================================================
            // === NOVO CÓDIGO ADICIONADO AQUI ===
            // Se a cirurgia foi realizada, adiciona o valor líquido como receita
            if (cirurgia.status === 'realizada' && cirurgia.valorLiquido > 0) {
                const receitaCirurgia = {
                    id: Date.now() + 1, // id ligeiramente diferente para evitar colisão
                    fonte: 'cirurgias',
                    descricao: `Líquido da Cirurgia: ${cirurgia.paciente} (${cirurgia.tipo})`,
                    valor: cirurgia.valorLiquido,
                    data: cirurgia.data
                };
                dados.receitas.push(receitaCirurgia);
                mostrarNotificacao('✅ Receita da cirurgia lançada automaticamente!', 'success');
            }
            // ================================================================
            
            e.target.reset();
            e.target.querySelector('input[type="date"]').value = new Date().toISOString().slice(0, 10);
            
            // Restaurar valores padrão
            document.getElementById('comissaoOrientadora').value = '3.0';
            document.getElementById('valorInstrumentadora').value = '200.00';
            
            // Limpar insumos
            document.getElementById('insumosUtilizados').innerHTML = `
                <div class="insumo-item" style="display: flex; gap: 10px; margin: 10px 0; align-items: center;">
                    <select class="insumo-select" style="flex: 2;">
                        <option value="">Selecione um insumo...</option>
                    </select>
                    <input type="number" class="quantidade-insumo" placeholder="Qtd" style="width: 80px;" min="1">
                    <span class="preco-insumo" style="width: 100px; font-weight: bold;"></span>
                    <button type="button" class="btn-remover-insumo" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px;">Remover</button>
                </div>
            `;
            
            // Reconfigurar eventos
            configurarEventosInsumo(document.querySelector('.insumo-item'));
            carregarInsumosNoSelect();
            
            // Resetar cálculos
            calcularResumoFinanceiro();
            
            atualizarTodasAsVisualizacoes();
            
            // Salvamento automático
            salvarAutomatico();
            mostrarNotificacao('🏥 Cirurgia registrada com sucesso!', 'success');
        });

        // Form de funcionários
        document.getElementById('formFuncionario').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!usuarioLogado) return;
            
            var formData = new FormData(e.target);
            var tipoPagamento = formData.get('tipoPagamento');
            
            var funcionario = {
                id: Date.now(),
                nome: formData.get('nome'),
                cargo: formData.get('cargo'),
                tipoPagamento: tipoPagamento,
                dataAdmissao: formData.get('dataAdmissao'),
                status: formData.get('status')
            };
            
            if (tipoPagamento === 'mensal') {
                funcionario.salario = parseFloat(formData.get('salario')) || 0;
            } else {
                funcionario.valorDiario = parseFloat(formData.get('valorDiario')) || 0;
            }

            dados.funcionarios.push(funcionario);
            
            e.target.reset();
            e.target.querySelector('input[type="date"]').value = new Date().toISOString().slice(0, 10);
            
            // Resetar campos de pagamento
            document.getElementById('salarioMensalGroup').style.display = 'block';
            document.getElementById('valorDiarioGroup').style.display = 'none';
            
            atualizarListaFuncionarios();
            atualizarResumoFuncionarios();
            
            // Recalcular custos de cirurgias se houver funcionários por dia
            calcularResumoFinanceiro();
            
            // Salvamento automático
            salvarAutomatico();
            mostrarNotificacao('👤 Funcionário registrado com sucesso!', 'success');
        });

        // Form de gastos fixos
        document.getElementById('formGastoFixo').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!usuarioLogado) return;
            
            var formData = new FormData(e.target);
            
            var gastoFixo = {
                id: Date.now(),
                descricao: formData.get('descricao'),
                categoria: formData.get('categoria'),
                valor: parseFloat(formData.get('valor')),
                diaVencimento: parseInt(formData.get('diaVencimento'))
            };

            dados.gastosFixos.push(gastoFixo);
            
            e.target.reset();
            atualizarListaGastosFixos();
            atualizarResumoGastosFixos();
            
            // Salvamento automático
            salvarAutomatico();
            mostrarNotificacao('📋 Gasto fixo adicionado com sucesso!', 'success');
        });

        // Form de parcelas
        document.getElementById('formParcela').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!usuarioLogado) return;
            
            var formData = new FormData(e.target);
            
            var parcela = {
                id: Date.now(),
                tipo: formData.get('tipo'),
                descricao: formData.get('descricao'),
                valor: parseFloat(formData.get('valor')),
                numeroParcelas: parseInt(formData.get('numeroParcelas')), // Captura o novo campo
                dataVencimento: formData.get('dataVencimento'),
                status: formData.get('status')
            };

            dados.parcelas.push(parcela);
            
            e.target.reset();
            e.target.querySelector('input[type="date"]').value = new Date().toISOString().slice(0, 10);
            atualizarListaParcelas();
            atualizarResumoParcelas();
            
            // Salvamento automático
            salvarAutomatico();
            mostrarNotificacao('📝 Parcela registrada com sucesso!', 'success');
        });

        // Form de insumos
        document.getElementById('formInsumo').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!usuarioLogado) return;
            
            var formData = new FormData(e.target);
            
            var insumo = {
                id: Date.now(),
                nome: formData.get('nome'),
                categoria: formData.get('categoria'),
                quantidade: parseInt(formData.get('quantidade')),
                unidade: formData.get('unidade'),
                preco: parseFloat(formData.get('preco')),
                estoqueMinimo: parseInt(formData.get('estoqueMinimo')),
                codigoBarras: formData.get('codigoBarras')
            };

            dados.insumos.push(insumo);
            
            e.target.reset();
            atualizarListaInsumos();
            atualizarResumoInsumos();
            
            // Salvamento automático
            salvarAutomatico();
            mostrarNotificacao('📦 Insumo adicionado com sucesso!', 'success');
        });

        // Atalhos de teclado
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !document.getElementById('telaLogin').classList.contains('hidden')) {
                e.preventDefault();
                realizarLogin();
            }
        });

        // === INICIALIZAÇÃO ===
        document.addEventListener('DOMContentLoaded', function() {
            // Definir data padrão nos campos
            var hoje = new Date().toISOString().slice(0, 10);
            var camposData = document.querySelectorAll('input[type="date"]');
            for (var i = 0; i < camposData.length; i++) {
                if (camposData[i].value === '') {
                    camposData[i].value = hoje;
                }
            }
            
            // Configurar eventos para cirurgias
            configurarEventosCirurgia();
            
            // Configurar eventos para funcionários
            configurarEventosFuncionarios();
            
            // Tentar carregar dados salvos na inicialização
            carregarDados();
            
            // Inicializar na tela de login
            mostrarLogin();
            
            // Atualizar status de salvamento
            atualizarStatusSalvamento();
        });

        function configurarEventosCirurgia() {
            // Event listeners para cálculo automático
            document.getElementById('valorBrutoCirurgia').addEventListener('input', calcularResumoFinanceiro);
            document.getElementById('comissaoOrientadora').addEventListener('input', calcularResumoFinanceiro);
            document.getElementById('valorInstrumentadora').addEventListener('input', calcularResumoFinanceiro);
            document.getElementById('outrosCustos').addEventListener('input', calcularResumoFinanceiro);
            document.getElementById('taxaCartaoCirurgia').addEventListener('input', calcularResumoFinanceiro);
            
            document.getElementById('formaPagamentoCirurgia').addEventListener('change', function() {
                var taxaGroup = document.getElementById('taxaCartaoGroup');
                var taxaInput = document.getElementById('taxaCartaoCirurgia');
                
                if (this.value.includes('cartao')) {
                    taxaGroup.style.display = 'block';
                    // Definir taxa padrão baseada no tipo de cartão
                    if (this.value === 'cartao-debito') {
                        taxaInput.value = '1.5';
                    } else if (this.value === 'cartao-credito-vista') {
                        taxaInput.value = '3.5';
                    } else if (this.value === 'cartao-credito-parcelado') {
                        taxaInput.value = '5.5';
                    }
                } else {
                    taxaGroup.style.display = 'none';
                    taxaInput.value = '';
                }
                calcularResumoFinanceiro();
            });
            
            // Configurar botão adicionar insumo
            document.getElementById('adicionarInsumo').addEventListener('click', adicionarLinhaInsumo);
            
            // Configurar eventos da primeira linha de insumo
            configurarEventosInsumo(document.querySelector('.insumo-item'));
        }

        function configurarEventosFuncionarios() {
            // Event listener para tipo de pagamento
            document.getElementById('tipoPagamentoFuncionario').addEventListener('change', function() {
                var salarioGroup = document.getElementById('salarioMensalGroup');
                var diarioGroup = document.getElementById('valorDiarioGroup');
                var salarioInput = document.getElementById('salarioMensal');
                var diarioInput = document.getElementById('valorDiario');
                
                if (this.value === 'mensal') {
                    salarioGroup.style.display = 'block';
                    diarioGroup.style.display = 'none';
                    salarioInput.required = true;
                    diarioInput.required = false;
                } else if (this.value === 'diario') {
                    salarioGroup.style.display = 'none';
                    diarioGroup.style.display = 'block';
                    salarioInput.required = false;
                    diarioInput.required = true;
                } else {
                    salarioGroup.style.display = 'block';
                    diarioGroup.style.display = 'none';
                    salarioInput.required = false;
                    diarioInput.required = false;
                }
            });
        }
    
    // === Busca por Código de Barras (escaneamento) ===
    function buscarInsumoPorCodigo(codigo) {
        const display = document.getElementById('resultadoBusca');
        if (!codigo) {
            display.innerHTML = '';
            return;
        }
        const insumo = dados.insumos.find(item => String(item.codigoBarras || '') === String(codigo));
        if (insumo) {
            display.innerHTML = `
                <p><strong>Produto:</strong> ${insumo.nome}</p>
                <p><strong>Categoria:</strong> ${insumo.categoria}</p>
                <p><strong>Quantidade:</strong> ${insumo.quantidade} ${insumo.unidade}</p>
                <p><strong>Preço Unitário:</strong> ${formatarMoeda(parseFloat(insumo.preco || 0))}</p>
                <p><strong>Código:</strong> ${insumo.codigoBarras || ''}</p>
            `;
        } else {
            display.innerHTML = "<p style='color:red'>Produto não encontrado</p>";
        }
    }

    (function() {
        var buscarInput = document.getElementById('buscarCodigoBarras');
        if (!buscarInput) return;
        buscarInput.addEventListener('input', function(e) {
            buscarInsumoPorCodigo(e.target.value.trim());
        });
        buscarInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                buscarInsumoPorCodigo(e.target.value.trim());
            }
        });
    })();

</script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js">
    // === Busca por Código de Barras (escaneamento) ===
    function buscarInsumoPorCodigo(codigo) {
        const display = document.getElementById('resultadoBusca');
        if (!codigo) {
            display.innerHTML = '';
            return;
        }
        const insumo = dados.insumos.find(item => String(item.codigoBarras || '') === String(codigo));
        if (insumo) {
            display.innerHTML = `
                <p><strong>Produto:</strong> ${insumo.nome}</p>
                <p><strong>Categoria:</strong> ${insumo.categoria}</p>
                <p><strong>Quantidade:</strong> ${insumo.quantidade} ${insumo.unidade}</p>
                <p><strong>Preço Unitário:</strong> ${formatarMoeda(parseFloat(insumo.preco || 0))}</p>
                <p><strong>Código:</strong> ${insumo.codigoBarras || ''}</p>
            `;
        } else {
            display.innerHTML = "<p style='color:red'>Produto não encontrado</p>";
        }
    }

    (function() {
        var buscarInput = document.getElementById('buscarCodigoBarras');
        if (!buscarInput) return;
        buscarInput.addEventListener('input', function(e) {
            buscarInsumoPorCodigo(e.target.value.trim());
        });
        buscarInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                buscarInsumoPorCodigo(e.target.value.trim());
            }
        });
    })();

</script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js">
    // === Busca por Código de Barras (escaneamento) ===
    function buscarInsumoPorCodigo(codigo) {
        const display = document.getElementById('resultadoBusca');
        if (!codigo) {
            display.innerHTML = '';
            return;
        }
        const insumo = dados.insumos.find(item => String(item.codigoBarras || '') === String(codigo));
        if (insumo) {
            display.innerHTML = `
                <p><strong>Produto:</strong> ${insumo.nome}</p>
                <p><strong>Categoria:</strong> ${insumo.categoria}</p>
                <p><strong>Quantidade:</strong> ${insumo.quantidade} ${insumo.unidade}</p>
                <p><strong>Preço Unitário:</strong> ${formatarMoeda(parseFloat(insumo.preco || 0))}</p>
                <p><strong>Código:</strong> ${insumo.codigoBarras || ''}</p>
            `;
        } else {
            display.innerHTML = "<p style='color:red'>Produto não encontrado</p>";
        }
    }

    (function() {
        var buscarInput = document.getElementById('buscarCodigoBarras');
        if (!buscarInput) return;
        buscarInput.addEventListener('input', function(e) {
            buscarInsumoPorCodigo(e.target.value.trim());
        });
        buscarInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                buscarInsumoPorCodigo(e.target.value.trim());
            }
        });
    })();

</script>

<script>
  // Configuracao Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyD1ruP7W5uYL185rOUnFqHd9GUlDp4VhXs",
    authDomain: "clinica-981e8.firebaseapp.com",
    databaseURL: "https://clinica-981e8-default-rtdb.firebaseio.com",
    projectId: "clinica-981e8",
    storageBucket: "clinica-981e8.firebasestorage.app",
    messagingSenderId: "766482530366",
    appId: "1:766482530366:web:31321baff2da7a8623916f"
  };

  // Inicializar Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  // Sobrescreve a funcao salvarDados para incluir Firebase
  function salvarDados() {
    try {
      const dadosParaSalvar = {
        ...dados,
        dataUltimaSalvamento: new Date().toISOString(),
        versaoSistema: '1.0'
      };

      // Tenta salvar na nuvem
      database.ref('sistemaFinanceiro').set(dadosParaSalvar)
        .then(() => {
          mostrarNotificacao('💾 Dados salvos na nuvem com sucesso!', 'success');
          localStorage.setItem('sistemaFinanceiro_ultimoSalvamento', new Date().toLocaleString('pt-BR'));
          atualizarStatusSalvamento();
        })
        .catch((error) => {
          console.error('Erro ao salvar no Firebase:', error);
          mostrarNotificacao('❌ Erro ao salvar na nuvem! Salvando localmente...', 'error');
          salvarDadosLocal();
        });
    } catch (error) {
      console.error('Erro inesperado ao salvar dados:', error);
      mostrarNotificacao('❌ Erro inesperado!', 'error');
    }
  }

  function salvarDadosLocal() {
    try {
      const dadosParaSalvar = {
        ...dados,
        dataUltimaSalvamento: new Date().toISOString(),
        versaoSistema: '1.0'
      };
      localStorage.setItem('sistemaFinanceiro_dados', JSON.stringify(dadosParaSalvar));
      localStorage.setItem('sistemaFinanceiro_ultimoSalvamento', new Date().toLocaleString('pt-BR'));
      atualizarStatusSalvamento();
    } catch (error) {
      console.error('Erro ao salvar dados localmente:', error);
    }
  }

  function carregarDados() {
    database.ref('sistemaFinanceiro').once('value')
      .then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          dados = {
            receitas: data.receitas || [],
            despesas: data.despesas || [],
            cirurgias: data.cirurgias || [],
            funcionarios: data.funcionarios || [],
            gastosFixos: data.gastosFixos || [],
            parcelas: data.parcelas || [],
            insumos: data.insumos || [],
            saldoAtual: data.saldoAtual || 0
          };
          mostrarNotificacao('📂 Dados carregados da nuvem com sucesso!', 'success');
          atualizarTodasAsVisualizacoes();
        } else {
          mostrarNotificacao('⚠️ Nenhum dado encontrado na nuvem. Carregando localmente...', 'warning');
          carregarDadosLocal();
        }
      })
      .catch((error) => {
        console.error('Erro ao carregar do Firebase:', error);
        mostrarNotificacao('❌ Erro ao carregar da nuvem! Carregando localmente...', 'error');
        carregarDadosLocal();
      });
  }

  function carregarDadosLocal() {
    try {
      const dadosSalvos = localStorage.getItem('sistemaFinanceiro_dados');
      if (dadosSalvos) {
        const dadosCarregados = JSON.parse(dadosSalvos);
        dados = {
          receitas: dadosCarregados.receitas || [],
          despesas: dadosCarregados.despesas || [],
          cirurgias: dadosCarregados.cirurgias || [],
          funcionarios: dadosCarregados.funcionarios || [],
          gastosFixos: dadosCarregados.gastosFixos || [],
          parcelas: dadosCarregados.parcelas || [],
          insumos: dadosCarregados.insumos || [],
          saldoAtual: dadosCarregados.saldoAtual || 0
        };
        return true;
      }
    } catch (error) {
      console.error('Erro ao carregar dados locais:', error);
    }
    return false;
  }

    // === Busca por Código de Barras (escaneamento) ===
    function buscarInsumoPorCodigo(codigo) {
        const display = document.getElementById('resultadoBusca');
        if (!codigo) {
            display.innerHTML = '';
            return;
        }
        const insumo = dados.insumos.find(item => String(item.codigoBarras || '') === String(codigo));
        if (insumo) {
            display.innerHTML = `
                <p><strong>Produto:</strong> ${insumo.nome}</p>
                <p><strong>Categoria:</strong> ${insumo.categoria}</p>
                <p><strong>Quantidade:</strong> ${insumo.quantidade} ${insumo.unidade}</p>
                <p><strong>Preço Unitário:</strong> ${formatarMoeda(parseFloat(insumo.preco || 0))}</p>
                <p><strong>Código:</strong> ${insumo.codigoBarras || ''}</p>
            `;
        } else {
            display.innerHTML = "<p style='color:red'>Produto não encontrado</p>";
        }
    }

    (function() {
        var buscarInput = document.getElementById('buscarCodigoBarras');
        if (!buscarInput) return;
        buscarInput.addEventListener('input', function(e) {
            buscarInsumoPorCodigo(e.target.value.trim());
        });
        buscarInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                buscarInsumoPorCodigo(e.target.value.trim());
            }
        });
    })();

</script>

</html>
