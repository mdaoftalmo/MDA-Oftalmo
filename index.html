<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Financeiro - Clinica Dr. Leonardo</title>
    <style>
        /* [MANTENHA TODOS OS SEUS ESTILOS ATUAIS] */
        /* Todos os seus estilos CSS existentes permanecem exatamente iguais */
    </style>
</head>
<body>
    <!-- [MANTENHA TODAS AS SUAS TELAS ATUAIS] -->
    <!-- Tela de Login e Sistema Financeiro permanecem exatamente iguais -->

    <script>
        // === CONFIGURAÇÕES DE LOGIN ===
        const USUARIO_VALIDO = 'leosht';
        const SENHA_VALIDA = 'mda12345';

        // === CONFIGURAÇÕES DO GITHUB API ===
        const GITHUB_USERNAME = 'mdaoftalmo'; // Substitua pelo seu usuário
        const GITHUB_REPO = 'https://mdaadm.com.br/'; // Substitua pelo nome do repositório
        const GITHUB_TOKEN = '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'; // Substitua pelo token gerado
        const DATA_FILE = 'clinica-data.json';

        // === DADOS DO SISTEMA ===
        let dados = {
            receitas: [],
            despesas: [],
            cirurgias: [],
            funcionarios: [],
            gastosFixos: [],
            parcelas: [],
            insumos: [],
            saldoAtual: 0
        };

        let usuarioLogado = false;

        // === FUNÇÕES GITHUB API ===
        async function salvarDadosGitHub() {
            try {
                const dadosParaSalvar = {
                    ...dados,
                    dataUltimaAtualizacao: new Date().toISOString(),
                    versaoSistema: '1.0'
                };
                
                // Obter SHA do arquivo existente (se houver)
                let sha = null;
                try {
                    const shaResponse = await fetch(
                        `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${DATA_FILE}`,
                        {
                            headers: {
                                'Authorization': `token ${GITHUB_TOKEN}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    
                    if (shaResponse.ok) {
                        const data = await shaResponse.json();
                        sha = data.sha;
                    }
                } catch (e) {
                    console.log('Arquivo ainda não existe ou erro ao obter SHA');
                }
                
                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${DATA_FILE}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify({
                            message: 'Atualização dos dados da clínica - ' + new Date().toLocaleString(),
                            content: btoa(unescape(encodeURIComponent(JSON.stringify(dadosParaSalvar)))),
                            sha: sha
                        })
                    }
                );
                
                if (response.ok) {
                    mostrarNotificacao('💾 Dados salvos no GitHub com sucesso!', 'success');
                    localStorage.setItem('sistemaFinanceiro_ultimoSalvamento', new Date().toLocaleString('pt-BR'));
                    atualizarStatusSalvamento();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Erro na resposta da API');
                }
            } catch (error) {
                console.error('Erro ao salvar no GitHub:', error);
                mostrarNotificacao('❌ Erro ao salvar dados no GitHub! ' + error.message, 'error');
                
                // Fallback para localStorage se o GitHub falhar
                localStorage.setItem('sistemaFinanceiro_dados', JSON.stringify(dados));
                mostrarNotificacao('⚠️ Dados salvos localmente como backup', 'warning');
            }
        }

        async function carregarDadosGitHub() {
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${DATA_FILE}`,
                    {
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    const content = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                    
                    // Manter compatibilidade com estrutura existente
                    dados = {
                        receitas: content.receitas || [],
                        despesas: content.despesas || [],
                        cirurgias: content.cirurgias || [],
                        funcionarios: content.funcionarios || [],
                        gastosFixos: content.gastosFixos || [],
                        parcelas: content.parcelas || [],
                        insumos: content.insumos || [],
                        saldoAtual: content.saldoAtual || 0
                    };
                    
                    mostrarNotificacao('📂 Dados carregados do GitHub!', 'success');
                    localStorage.setItem('sistemaFinanceiro_ultimoSalvamento', new Date().toLocaleString('pt-BR'));
                    atualizarStatusSalvamento();
                    return true;
                } else if (response.status === 404) {
                    // Arquivo não existe ainda - tentar carregar do localStorage
                    return carregarDadosLocal();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Erro na resposta da API');
                }
            } catch (error) {
                console.error('Erro ao carregar do GitHub:', error);
                mostrarNotificacao('❌ Erro ao carregar dados do GitHub! ' + error.message, 'error');
                
                // Fallback para localStorage se o GitHub falhar
                return carregarDadosLocal();
            }
        }

        function carregarDadosLocal() {
            try {
                const dadosSalvos = localStorage.getItem('sistemaFinanceiro_dados');
                if (dadosSalvos) {
                    const dadosCarregados = JSON.parse(dadosSalvos);
                    
                    dados = {
                        receitas: dadosCarregados.receitas || [],
                        despesas: dadosCarregados.despesas || [],
                        cirurgias: dadosCarregados.cirurgias || [],
                        funcionarios: dadosCarregados.funcionarios || [],
                        gastosFixos: dadosCarregados.gastosFixos || [],
                        parcelas: dadosCarregados.parcelas || [],
                        insumos: dadosCarregados.insumos || [],
                        saldoAtual: dadosCarregados.saldoAtual || 0
                    };
                    
                    mostrarNotificacao('📂 Dados carregados do cache local', 'info');
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Erro ao carregar dados locais:', error);
                return false;
            }
        }

        // === FUNÇÕES DE SALVAMENTO MODIFICADAS ===
        function salvarDados() {
            if (usuarioLogado) {
                salvarDadosGitHub().catch(console.error);
            }
        }

        function carregarDados() {
            if (usuarioLogado) {
                carregarDadosGitHub().then(success => {
                    if (success) {
                        atualizarTodasAsVisualizacoes();
                    }
                });
            }
        }

        // [MANTENHA TODAS AS SUAS OUTRAS FUNÇÕES EXISTENTES]
        // Todas as suas funções de login, formulários, cálculos, etc. permanecem iguais
        // Apenas substitua as chamadas de Firebase pelas funções do GitHub API

        // === MODIFICAÇÕES NOS BOTÕES ===
        // No seu HTML, substitua os botões de Firebase por:
        /*
        <button onclick="salvarDados()" style="background: rgba(40,167,69,0.8); border: 1px solid white; color: white; padding: 8px 15px; border-radius: 5px; margin: 5px; cursor: pointer;">
            💾 Salvar Dados na Nuvem
        </button>
        <button onclick="carregarDados()" style="background: rgba(0,123,255,0.8); border: 1px solid white; color: white; padding: 8px 15px; border-radius: 5px; margin: 5px; cursor: pointer;">
            🔄 Carregar Dados da Nuvem
        </button>
        */

        // === INICIALIZAÇÃO ===
        document.addEventListener('DOMContentLoaded', function() {
            // Definir data padrão nos campos
            var hoje = new Date().toISOString().slice(0, 10);
            var camposData = document.querySelectorAll('input[type="date"]');
            for (var i = 0; i < camposData.length; i++) {
                if (camposData[i].value === '') {
                    camposData[i].value = hoje;
                }
            }
            
            // Configurar eventos para cirurgias
            configurarEventosCirurgia();
            
            // Configurar eventos para funcionários
            configurarEventosFuncionarios();
            
            // Inicializar na tela de login
            mostrarLogin();
            
            // Atualizar status de salvamento
            atualizarStatusSalvamento();
        });
    </script>
</body>
</html>
